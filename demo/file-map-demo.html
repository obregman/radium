<!DOCTYPE html>
<!--
  Radium Files Map Visualization - Standalone Demo
  
  This is a self-contained demo of the Radium VSCode extension's Files Map view.
  
  HOW TO USE:
  1. Open this file in any modern web browser
  2. Demo data loads automatically
  3. Explore the interactive file and directory graph
  4. Use mouse to pan/zoom, click files to see details
  
  FEATURES DEMONSTRATED:
  - Interactive file and directory graph with force-directed layout
  - Color modes: by directory, by symbol usage, by code smell
  - File size visualization (based on line count)
  - Directory grouping with pinnable positions
  - Search functionality
  - Symbol lists (functions, variables, types)
  - Code smell metrics
  
  This demo uses the exact same visualization code as the VSCode extension,
  just with mock data instead of real workspace indexing.
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radium Files Map - Demo</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* ============================================
       DEMO-SPECIFIC STYLES
       ============================================ */
    :root {
      --vscode-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    #demo-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #demo-header h1 {
      margin: 0;
      font-size: 40, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 26, 30, 30, 0.95);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    #search-box {
      background: #2d2d2d;
      color: #d4d4d4;
      border: 1px solid #555;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 26, 255, 255, 0.5));
    }
    
    .edge-file {
      fill: none;
      stroke-width: 1.5;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    
    .edge-file:hover {
      opacity: 1;
      stroke-width: 2.5;
    }
    
    .edge-directory {
      fill: none;
      stroke: #4a9eff;
      stroke-width: 5;
      opacity: 0.95;
    }
    
    .node-label {
      font-size: 28, 30, 30, 0.95);
      color: #d4d4d4;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #555;
      font-size: 26, 0, 0, 0.5);
    }
    
    #tooltip.visible {
      opacity: 1;
    }
    
    .tooltip-filename {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tooltip-lines {
      font-size: 22, 30, 30, 0.95);
      color: #d4d4d4;
      padding: 8px 12px;
      font-size: 26, 0, 0, 0.5);
      width: 100%;
      box-sizing: border-box;
    }
    
    .smell-details-panel.visible {
      opacity: 1;
    }
    
    .smell-header {
      font-size: 26, 0, 0, 0.5);
      width: fit-content;
      min-width: 80px;
    }
    
    .symbol-list-panel::-webkit-scrollbar {
      width: 6px;
    }
    
    .symbol-list-panel::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 3px;
    }
    
    .symbol-list-panel::-webkit-scrollbar-thumb {
      background: #666;
      border-radius: 3px;
    }
    
    .symbol-list-panel::-webkit-scrollbar-thumb:hover {
      background: #888;
    }
    
    .symbol-list-item {
      padding: 1px 0;
      white-space: nowrap;
      font-family: 'Courier New', monospace;
    }
    
    #zoom-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(30, 30, 30, 0.95);
      color: #d4d4d4;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #444;
      font-size: 28, monospace;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div id="demo-header">
    <div>
      <h1>üó∫Ô∏è Radium Files Map Visualization</h1>
      <div class="subtitle">Interactive file and directory dependency graph</div>
    </div>
    <div id="demo-info">
      <span>üìä Demo Mode - Sample Project Loaded</span>
    </div>
  </div>

  <div id="controls">
    <input type="text" id="search-box" placeholder="Search files and directories..." />
    <select id="color-mode-select">
      <option value="directory">Color by Parent Directory</option>
      <option value="symbol">Color by Symbol Use</option>
      <option value="smell">Color by Code Smell</option>
    </select>
  </div>
  <div id="tooltip">
    <div class="tooltip-filename"></div>
    <div class="tooltip-lines"></div>
  </div>
  <div id="zoom-indicator">100%</div>
  <svg id="graph"></svg>
  
  <script>
    console.log('[Files Map Demo] Starting...');
    
    // Mock vscode API for demo
    const vscode = {
      postMessage: (message) => {
        console.log('[Demo] Message:', message);
        
        // Handle messages that would normally go to the extension
        if (message.type === 'ready') {
          // Send initial graph data
          setTimeout(() => {
            window.dispatchEvent(new MessageEvent('message', {
              data: { type: 'graph:update', data: MOCK_GRAPH_DATA }
            }));
          }, 100);
        } else if (message.type === 'file:open') {
          alert(`In the VSCode extension, this would open:\n${message.filePath}`);
        } else if (message.type === 'file:copy') {
          alert(`Copied to clipboard:\n${message.filePath}`);
        } else if (message.type === 'dir:unpin') {
          // Simulate unpinning
          window.dispatchEvent(new MessageEvent('message', {
            data: { type: 'dir:unpinned', dirPath: message.dirPath }
          }));
        }
      }
    };
    
    // Mock graph data
    const MOCK_GRAPH_DATA = {
      nodes: [
        // Root directory nodes
        { id: 'dir:src', type: 'directory', label: 'src', path: 'src', fileCount: 60, depth: 0 },
        { id: 'dir:tests', type: 'directory', label: 'tests', path: 'tests', fileCount: 15, depth: 0 },
        { id: 'dir:docs', type: 'directory', label: 'docs', path: 'docs', fileCount: 8, depth: 0 },
        
        // src subdirectories (level 1)
        { id: 'dir:src/services', type: 'directory', label: 'src/services', path: 'src/services', fileCount: 12, depth: 1 },
        { id: 'dir:src/models', type: 'directory', label: 'src/models', path: 'src/models', fileCount: 5, depth: 1 },
        { id: 'dir:src/utils', type: 'directory', label: 'src/utils', path: 'src/utils', fileCount: 6, depth: 1 },
        { id: 'dir:src/controllers', type: 'directory', label: 'src/controllers', path: 'src/controllers', fileCount: 11, depth: 1 },
        { id: 'dir:src/middleware', type: 'directory', label: 'src/middleware', path: 'src/middleware', fileCount: 5, depth: 1 },
        { id: 'dir:src/config', type: 'directory', label: 'src/config', path: 'src/config', fileCount: 4, depth: 1 },
        { id: 'dir:src/types', type: 'directory', label: 'src/types', path: 'src/types', fileCount: 7, depth: 1 },
        
        // tests subdirectories (level 1)
        { id: 'dir:tests/unit', type: 'directory', label: 'tests/unit', path: 'tests/unit', fileCount: 8, depth: 1 },
        { id: 'dir:tests/integration', type: 'directory', label: 'tests/integration', path: 'tests/integration', fileCount: 7, depth: 1 },
        
        // docs subdirectories (level 1)
        { id: 'dir:docs/api', type: 'directory', label: 'docs/api', path: 'docs/api', fileCount: 4, depth: 1 },
        { id: 'dir:docs/guides', type: 'directory', label: 'docs/guides', path: 'docs/guides', fileCount: 4, depth: 1 },
        
        // src/services subdirectories (level 2)
        { id: 'dir:src/services/external', type: 'directory', label: 'src/services/external', path: 'src/services/external', fileCount: 4, depth: 2 },
        { id: 'dir:src/services/internal', type: 'directory', label: 'src/services/internal', path: 'src/services/internal', fileCount: 3, depth: 2 },
        
        // src/models subdirectories (level 2)
        { id: 'dir:src/models/schemas', type: 'directory', label: 'src/models/schemas', path: 'src/models/schemas', fileCount: 3, depth: 2 },
        { id: 'dir:src/models/validators', type: 'directory', label: 'src/models/validators', path: 'src/models/validators', fileCount: 3, depth: 2 },
        
        // src/utils subdirectories (level 2)
        { id: 'dir:src/utils/formatters', type: 'directory', label: 'src/utils/formatters', path: 'src/utils/formatters', fileCount: 4, depth: 2 },
        { id: 'dir:src/utils/parsers', type: 'directory', label: 'src/utils/parsers', path: 'src/utils/parsers', fileCount: 3, depth: 2 },
        
        // src/controllers subdirectories (level 2)
        { id: 'dir:src/controllers/api', type: 'directory', label: 'src/controllers/api', path: 'src/controllers/api', fileCount: 5, depth: 2 },
        { id: 'dir:src/controllers/webhooks', type: 'directory', label: 'src/controllers/webhooks', path: 'src/controllers/webhooks', fileCount: 3, depth: 2 },
        
        // src/types subdirectories (level 2)
        { id: 'dir:src/types/dto', type: 'directory', label: 'src/types/dto', path: 'src/types/dto', fileCount: 5, depth: 2 },
        { id: 'dir:src/types/enums', type: 'directory', label: 'src/types/enums', path: 'src/types/enums', fileCount: 4, depth: 2 },
        
        // tests/unit subdirectories (level 2)
        { id: 'dir:tests/unit/services', type: 'directory', label: 'tests/unit/services', path: 'tests/unit/services', fileCount: 5, depth: 2 },
        { id: 'dir:tests/unit/utils', type: 'directory', label: 'tests/unit/utils', path: 'tests/unit/utils', fileCount: 4, depth: 2 },
        
        // tests/integration subdirectories (level 2)
        { id: 'dir:tests/integration/api', type: 'directory', label: 'tests/integration/api', path: 'tests/integration/api', fileCount: 4, depth: 2 },
        { id: 'dir:tests/integration/e2e', type: 'directory', label: 'tests/integration/e2e', path: 'tests/integration/e2e', fileCount: 3, depth: 2 },
        
        // File nodes - src/services
        {
          id: 'src/services/user-service.ts',
          type: 'file',
          label: 'user-service.ts',
          path: 'src/services/user-service.ts',
          lines: 150,
          lang: 'typescript',
          size: 400,
          exportedSymbols: 5,
          smellScore: 35,
          smellDetails: {
            functionCount: 8,
            avgFunctionLength: 15,
            maxFunctionLength: 45,
            maxNestingDepth: 3,
            importCount: 6
          },
          functions: ['authenticateUser()', 'createUser()', 'updateUser()', 'deleteUser()', 'findUserById()'],
          variables: ['userCache', 'sessionStore'],
          types: ['UserRepository']
        },
        {
          id: 'src/services/auth-service.ts',
          type: 'file',
          label: 'auth-service.ts',
          path: 'src/services/auth-service.ts',
          lines: 95,
          lang: 'typescript',
          size: 340,
          exportedSymbols: 3,
          smellScore: 20,
          smellDetails: {
            functionCount: 5,
            avgFunctionLength: 12,
            maxFunctionLength: 28,
            maxNestingDepth: 2,
            importCount: 4
          },
          functions: ['generateToken()', 'validateToken()', 'refreshToken()'],
          variables: ['tokenSecret'],
          types: ['TokenPayload']
        },
        {
          id: 'src/services/email-service.ts',
          type: 'file',
          label: 'email-service.ts',
          path: 'src/services/email-service.ts',
          lines: 180,
          lang: 'typescript',
          size: 420,
          exportedSymbols: 4,
          smellScore: 42,
          smellDetails: {
            functionCount: 9,
            avgFunctionLength: 18,
            maxFunctionLength: 52,
            maxNestingDepth: 3,
            importCount: 7
          },
          functions: ['sendEmail()', 'sendWelcomeEmail()', 'sendPasswordReset()', 'sendVerification()'],
          variables: ['smtpConfig', 'emailQueue'],
          types: ['EmailTemplate']
        },
        {
          id: 'src/services/payment-service.ts',
          type: 'file',
          label: 'payment-service.ts',
          path: 'src/services/payment-service.ts',
          lines: 220,
          lang: 'typescript',
          size: 470,
          exportedSymbols: 6,
          smellScore: 58,
          smellDetails: {
            functionCount: 12,
            avgFunctionLength: 22,
            maxFunctionLength: 65,
            maxNestingDepth: 4,
            importCount: 9
          },
          functions: ['processPayment()', 'refundPayment()', 'validateCard()', 'getTransactionHistory()'],
          variables: ['stripeClient', 'paymentCache'],
          types: ['PaymentIntent', 'PaymentMethod']
        },
        {
          id: 'src/services/notification-service.ts',
          type: 'file',
          label: 'notification-service.ts',
          path: 'src/services/notification-service.ts',
          lines: 145,
          lang: 'typescript',
          size: 390,
          exportedSymbols: 5,
          smellScore: 38,
          smellDetails: {
            functionCount: 8,
            avgFunctionLength: 16,
            maxFunctionLength: 42,
            maxNestingDepth: 3,
            importCount: 5
          },
          functions: ['sendNotification()', 'sendPushNotification()', 'sendSMS()', 'scheduleNotification()'],
          variables: ['notificationQueue', 'fcmClient'],
          types: ['Notification']
        },
        {
          id: 'src/services/storage-service.ts',
          type: 'file',
          label: 'storage-service.ts',
          path: 'src/services/storage-service.ts',
          lines: 165,
          lang: 'typescript',
          size: 400,
          exportedSymbols: 7,
          smellScore: 32,
          smellDetails: {
            functionCount: 10,
            avgFunctionLength: 14,
            maxFunctionLength: 38,
            maxNestingDepth: 2,
            importCount: 6
          },
          functions: ['uploadFile()', 'downloadFile()', 'deleteFile()', 'listFiles()', 'getFileUrl()'],
          variables: ['s3Client', 'bucketName'],
          types: ['StorageConfig', 'FileMetadata']
        },
        {
          id: 'src/services/cache-service.ts',
          type: 'file',
          label: 'cache-service.ts',
          path: 'src/services/cache-service.ts',
          lines: 110,
          lang: 'typescript',
          size: 350,
          exportedSymbols: 4,
          smellScore: 22,
          smellDetails: {
            functionCount: 7,
            avgFunctionLength: 11,
            maxFunctionLength: 25,
            maxNestingDepth: 2,
            importCount: 3
          },
          functions: ['get()', 'set()', 'delete()', 'clear()', 'has()'],
          variables: ['redisClient', 'defaultTTL'],
          types: ['CacheOptions']
        },
        {
          id: 'src/services/analytics-service.ts',
          type: 'file',
          label: 'analytics-service.ts',
          path: 'src/services/analytics-service.ts',
          lines: 190,
          lang: 'typescript',
          size: 430,
          exportedSymbols: 5,
          smellScore: 48,
          smellDetails: {
            functionCount: 11,
            avgFunctionLength: 19,
            maxFunctionLength: 55,
            maxNestingDepth: 4,
            importCount: 8
          },
          functions: ['trackEvent()', 'trackPageView()', 'trackUser()', 'generateReport()'],
          variables: ['analyticsClient', 'eventQueue'],
          types: ['AnalyticsEvent', 'UserMetrics']
        },
        {
          id: 'src/services/search-service.ts',
          type: 'file',
          label: 'search-service.ts',
          path: 'src/services/search-service.ts',
          lines: 205,
          lang: 'typescript',
          size: 450,
          exportedSymbols: 6,
          smellScore: 52,
          smellDetails: {
            functionCount: 13,
            avgFunctionLength: 20,
            maxFunctionLength: 58,
            maxNestingDepth: 3,
            importCount: 7
          },
          functions: ['search()', 'indexDocument()', 'deleteDocument()', 'updateIndex()', 'suggest()'],
          variables: ['elasticClient', 'indexName'],
          types: ['SearchQuery', 'SearchResult']
        },
        {
          id: 'src/services/webhook-service.ts',
          type: 'file',
          label: 'webhook-service.ts',
          path: 'src/services/webhook-service.ts',
          lines: 135,
          lang: 'typescript',
          size: 370,
          exportedSymbols: 3,
          smellScore: 36,
          smellDetails: {
            functionCount: 8,
            avgFunctionLength: 15,
            maxFunctionLength: 40,
            maxNestingDepth: 3,
            importCount: 5
          },
          functions: ['registerWebhook()', 'triggerWebhook()', 'validateSignature()', 'retryWebhook()'],
          variables: ['webhookQueue', 'secretKey'],
          types: ['WebhookPayload']
        },
        {
          id: 'src/services/rate-limiter-service.ts',
          type: 'file',
          label: 'rate-limiter-service.ts',
          path: 'src/services/rate-limiter-service.ts',
          lines: 88,
          lang: 'typescript',
          size: 320,
          exportedSymbols: 2,
          smellScore: 18,
          smellDetails: {
            functionCount: 5,
            avgFunctionLength: 10,
            maxFunctionLength: 22,
            maxNestingDepth: 2,
            importCount: 3
          },
          functions: ['checkLimit()', 'incrementCounter()', 'resetCounter()'],
          variables: ['rateLimits'],
          types: ['RateLimitConfig']
        },
        
        // File nodes - src/models
        {
          id: 'src/models/user.model.ts',
          type: 'file',
          label: 'user.model.ts',
          path: 'src/models/user.model.ts',
          lines: 45,
          lang: 'typescript',
          size: 300,
          exportedSymbols: 2,
          smellScore: 10,
          smellDetails: {
            functionCount: 0,
            avgFunctionLength: 0,
            maxFunctionLength: 0,
            maxNestingDepth: 0,
            importCount: 1
          },
          functions: [],
          variables: [],
          types: ['User', 'UserSession']
        },
        
        // File nodes - src/utils
        {
          id: 'src/utils/validation.ts',
          type: 'file',
          label: 'validation.ts',
          path: 'src/utils/validation.ts',
          lines: 85,
          lang: 'typescript',
          size: 330,
          exportedSymbols: 4,
          smellScore: 25,
          smellDetails: {
            functionCount: 6,
            avgFunctionLength: 8,
            maxFunctionLength: 15,
            maxNestingDepth: 2,
            importCount: 2
          },
          functions: ['validateEmail()', 'validatePassword()', 'validateUsername()'],
          variables: [],
          types: []
        },
        {
          id: 'src/utils/logger.ts',
          type: 'file',
          label: 'logger.ts',
          path: 'src/utils/logger.ts',
          lines: 120,
          lang: 'typescript',
          size: 370,
          exportedSymbols: 1,
          smellScore: 45,
          smellDetails: {
            functionCount: 10,
            avgFunctionLength: 8,
            maxFunctionLength: 20,
            maxNestingDepth: 3,
            importCount: 3
          },
          functions: ['log()', 'warn()', 'error()', 'debug()', 'info()'],
          variables: ['logLevel', 'logFile'],
          types: ['LogLevel']
        },
        
        // File nodes - src/controllers
        {
          id: 'src/controllers/auth.controller.ts',
          type: 'file',
          label: 'auth.controller.ts',
          path: 'src/controllers/auth.controller.ts',
          lines: 120,
          lang: 'typescript',
          size: 380,
          exportedSymbols: 1,
          smellScore: 55,
          smellDetails: {
            functionCount: 7,
            avgFunctionLength: 18,
            maxFunctionLength: 35,
            maxNestingDepth: 4,
            importCount: 8
          },
          functions: ['login()', 'register()', 'logout()', 'refreshToken()'],
          variables: [],
          types: ['AuthController']
        },
        {
          id: 'src/controllers/user.controller.ts',
          type: 'file',
          label: 'user.controller.ts',
          path: 'src/controllers/user.controller.ts',
          lines: 185,
          lang: 'typescript',
          size: 430,
          exportedSymbols: 1,
          smellScore: 62,
          smellDetails: {
            functionCount: 10,
            avgFunctionLength: 20,
            maxFunctionLength: 48,
            maxNestingDepth: 4,
            importCount: 10
          },
          functions: ['getUser()', 'updateUser()', 'deleteUser()', 'listUsers()', 'searchUsers()'],
          variables: [],
          types: ['UserController']
        },
        {
          id: 'src/controllers/product.controller.ts',
          type: 'file',
          label: 'product.controller.ts',
          path: 'src/controllers/product.controller.ts',
          lines: 210,
          lang: 'typescript',
          size: 460,
          exportedSymbols: 1,
          smellScore: 68,
          smellDetails: {
            functionCount: 12,
            avgFunctionLength: 22,
            maxFunctionLength: 55,
            maxNestingDepth: 5,
            importCount: 11
          },
          functions: ['getProduct()', 'createProduct()', 'updateProduct()', 'deleteProduct()', 'listProducts()'],
          variables: [],
          types: ['ProductController']
        },
        {
          id: 'src/controllers/order.controller.ts',
          type: 'file',
          label: 'order.controller.ts',
          path: 'src/controllers/order.controller.ts',
          lines: 245,
          lang: 'typescript',
          size: 510,
          exportedSymbols: 1,
          smellScore: 72,
          smellDetails: {
            functionCount: 14,
            avgFunctionLength: 24,
            maxFunctionLength: 62,
            maxNestingDepth: 5,
            importCount: 13
          },
          functions: ['createOrder()', 'getOrder()', 'updateOrder()', 'cancelOrder()', 'listOrders()'],
          variables: [],
          types: ['OrderController']
        },
        {
          id: 'src/controllers/payment.controller.ts',
          type: 'file',
          label: 'payment.controller.ts',
          path: 'src/controllers/payment.controller.ts',
          lines: 165,
          lang: 'typescript',
          size: 400,
          exportedSymbols: 1,
          smellScore: 58,
          smellDetails: {
            functionCount: 9,
            avgFunctionLength: 19,
            maxFunctionLength: 45,
            maxNestingDepth: 4,
            importCount: 9
          },
          functions: ['processPayment()', 'refundPayment()', 'getPaymentStatus()', 'listPayments()'],
          variables: [],
          types: ['PaymentController']
        },
        {
          id: 'src/controllers/notification.controller.ts',
          type: 'file',
          label: 'notification.controller.ts',
          path: 'src/controllers/notification.controller.ts',
          lines: 130,
          lang: 'typescript',
          size: 360,
          exportedSymbols: 1,
          smellScore: 45,
          smellDetails: {
            functionCount: 7,
            avgFunctionLength: 16,
            maxFunctionLength: 38,
            maxNestingDepth: 3,
            importCount: 7
          },
          functions: ['sendNotification()', 'getNotifications()', 'markAsRead()', 'deleteNotification()'],
          variables: [],
          types: ['NotificationController']
        },
        {
          id: 'src/controllers/analytics.controller.ts',
          type: 'file',
          label: 'analytics.controller.ts',
          path: 'src/controllers/analytics.controller.ts',
          lines: 195,
          lang: 'typescript',
          size: 440,
          exportedSymbols: 1,
          smellScore: 64,
          smellDetails: {
            functionCount: 11,
            avgFunctionLength: 21,
            maxFunctionLength: 52,
            maxNestingDepth: 4,
            importCount: 10
          },
          functions: ['getAnalytics()', 'trackEvent()', 'generateReport()', 'exportData()'],
          variables: [],
          types: ['AnalyticsController']
        },
        {
          id: 'src/controllers/search.controller.ts',
          type: 'file',
          label: 'search.controller.ts',
          path: 'src/controllers/search.controller.ts',
          lines: 155,
          lang: 'typescript',
          size: 390,
          exportedSymbols: 1,
          smellScore: 52,
          smellDetails: {
            functionCount: 8,
            avgFunctionLength: 18,
            maxFunctionLength: 42,
            maxNestingDepth: 3,
            importCount: 8
          },
          functions: ['search()', 'advancedSearch()', 'getSuggestions()', 'reindex()'],
          variables: [],
          types: ['SearchController']
        },
        {
          id: 'src/controllers/webhook.controller.ts',
          type: 'file',
          label: 'webhook.controller.ts',
          path: 'src/controllers/webhook.controller.ts',
          lines: 140,
          lang: 'typescript',
          size: 370,
          exportedSymbols: 1,
          smellScore: 48,
          smellDetails: {
            functionCount: 8,
            avgFunctionLength: 17,
            maxFunctionLength: 40,
            maxNestingDepth: 3,
            importCount: 7
          },
          functions: ['registerWebhook()', 'handleWebhook()', 'listWebhooks()', 'deleteWebhook()'],
          variables: [],
          types: ['WebhookController']
        },
        {
          id: 'src/controllers/admin.controller.ts',
          type: 'file',
          label: 'admin.controller.ts',
          path: 'src/controllers/admin.controller.ts',
          lines: 280,
          lang: 'typescript',
          size: 560,
          exportedSymbols: 1,
          smellScore: 78,
          smellDetails: {
            functionCount: 16,
            avgFunctionLength: 26,
            maxFunctionLength: 72,
            maxNestingDepth: 6,
            importCount: 15
          },
          functions: ['manageUsers()', 'manageProducts()', 'viewLogs()', 'systemSettings()', 'backupData()'],
          variables: [],
          types: ['AdminController']
        },
        
        // File nodes - src/models
        { id: 'src/models/product.model.ts', type: 'file', label: 'product.model.ts', path: 'src/models/product.model.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 2, smellScore: 18, functions: [], variables: [], types: ['Product', 'ProductSchema'] },
        { id: 'src/models/order.model.ts', type: 'file', label: 'order.model.ts', path: 'src/models/order.model.ts', lines: 95, lang: 'typescript', size: 340, exportedSymbols: 2, smellScore: 22, functions: [], variables: [], types: ['Order', 'OrderSchema'] },
        { id: 'src/models/payment.model.ts', type: 'file', label: 'payment.model.ts', path: 'src/models/payment.model.ts', lines: 75, lang: 'typescript', size: 310, exportedSymbols: 2, smellScore: 15, functions: [], variables: [], types: ['Payment', 'PaymentSchema'] },
        { id: 'src/models/notification.model.ts', type: 'file', label: 'notification.model.ts', path: 'src/models/notification.model.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 2, smellScore: 12, functions: [], variables: [], types: ['Notification', 'NotificationSchema'] },
        
        // File nodes - src/middleware
        { id: 'src/middleware/auth.middleware.ts', type: 'file', label: 'auth.middleware.ts', path: 'src/middleware/auth.middleware.ts', lines: 120, lang: 'typescript', size: 360, exportedSymbols: 3, smellScore: 28, functions: ['authenticate()', 'authorize()', 'checkPermissions()'], variables: [], types: [] },
        { id: 'src/middleware/validation.middleware.ts', type: 'file', label: 'validation.middleware.ts', path: 'src/middleware/validation.middleware.ts', lines: 95, lang: 'typescript', size: 330, exportedSymbols: 2, smellScore: 20, functions: ['validateBody()', 'validateParams()'], variables: [], types: [] },
        { id: 'src/middleware/error.middleware.ts', type: 'file', label: 'error.middleware.ts', path: 'src/middleware/error.middleware.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 1, smellScore: 18, functions: ['errorHandler()'], variables: [], types: [] },
        { id: 'src/middleware/rate-limit.middleware.ts', type: 'file', label: 'rate-limit.middleware.ts', path: 'src/middleware/rate-limit.middleware.ts', lines: 75, lang: 'typescript', size: 300, exportedSymbols: 2, smellScore: 22, functions: ['rateLimiter()', 'checkLimit()'], variables: [], types: [] },
        { id: 'src/middleware/cors.middleware.ts', type: 'file', label: 'cors.middleware.ts', path: 'src/middleware/cors.middleware.ts', lines: 55, lang: 'typescript', size: 270, exportedSymbols: 1, smellScore: 10, functions: ['corsHandler()'], variables: [], types: [] },
        
        // File nodes - src/config
        { id: 'src/config/database.config.ts', type: 'file', label: 'database.config.ts', path: 'src/config/database.config.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 1, smellScore: 15, functions: [], variables: ['dbConfig'], types: ['DatabaseConfig'] },
        { id: 'src/config/app.config.ts', type: 'file', label: 'app.config.ts', path: 'src/config/app.config.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 1, smellScore: 18, functions: [], variables: ['appConfig'], types: ['AppConfig'] },
        { id: 'src/config/auth.config.ts', type: 'file', label: 'auth.config.ts', path: 'src/config/auth.config.ts', lines: 55, lang: 'typescript', size: 270, exportedSymbols: 1, smellScore: 12, functions: [], variables: ['authConfig'], types: ['AuthConfig'] },
        { id: 'src/config/email.config.ts', type: 'file', label: 'email.config.ts', path: 'src/config/email.config.ts', lines: 45, lang: 'typescript', size: 250, exportedSymbols: 1, smellScore: 8, functions: [], variables: ['emailConfig'], types: ['EmailConfig'] },
        
        // File nodes - src/types
        { id: 'src/types/user.types.ts', type: 'file', label: 'user.types.ts', path: 'src/types/user.types.ts', lines: 45, lang: 'typescript', size: 250, exportedSymbols: 5, smellScore: 5, functions: [], variables: [], types: ['UserDTO', 'CreateUserDTO', 'UpdateUserDTO', 'UserRole', 'UserStatus'] },
        { id: 'src/types/product.types.ts', type: 'file', label: 'product.types.ts', path: 'src/types/product.types.ts', lines: 55, lang: 'typescript', size: 270, exportedSymbols: 4, smellScore: 8, functions: [], variables: [], types: ['ProductDTO', 'CreateProductDTO', 'UpdateProductDTO', 'ProductCategory'] },
        { id: 'src/types/order.types.ts', type: 'file', label: 'order.types.ts', path: 'src/types/order.types.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 5, smellScore: 10, functions: [], variables: [], types: ['OrderDTO', 'CreateOrderDTO', 'OrderStatus', 'OrderItem', 'ShippingInfo'] },
        { id: 'src/types/payment.types.ts', type: 'file', label: 'payment.types.ts', path: 'src/types/payment.types.ts', lines: 50, lang: 'typescript', size: 260, exportedSymbols: 4, smellScore: 7, functions: [], variables: [], types: ['PaymentDTO', 'PaymentStatus', 'PaymentMethod', 'RefundDTO'] },
        { id: 'src/types/api.types.ts', type: 'file', label: 'api.types.ts', path: 'src/types/api.types.ts', lines: 75, lang: 'typescript', size: 310, exportedSymbols: 6, smellScore: 12, functions: [], variables: [], types: ['ApiResponse', 'ApiError', 'PaginationParams', 'SortParams', 'FilterParams', 'ApiConfig'] },
        { id: 'src/types/common.types.ts', type: 'file', label: 'common.types.ts', path: 'src/types/common.types.ts', lines: 40, lang: 'typescript', size: 240, exportedSymbols: 3, smellScore: 5, functions: [], variables: [], types: ['ID', 'Timestamp', 'Nullable'] },
        { id: 'src/types/validation.types.ts', type: 'file', label: 'validation.types.ts', path: 'src/types/validation.types.ts', lines: 60, lang: 'typescript', size: 280, exportedSymbols: 4, smellScore: 9, functions: [], variables: [], types: ['ValidationRule', 'ValidationError', 'ValidationResult', 'ValidatorOptions'] },
        
        // File nodes - src/utils (additional)
        { id: 'src/utils/date.utils.ts', type: 'file', label: 'date.utils.ts', path: 'src/utils/date.utils.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 8, smellScore: 15, functions: ['formatDate()', 'parseDate()', 'addDays()', 'diffDays()', 'isWeekend()', 'getQuarter()'], variables: [], types: [] },
        { id: 'src/utils/string.utils.ts', type: 'file', label: 'string.utils.ts', path: 'src/utils/string.utils.ts', lines: 95, lang: 'typescript', size: 340, exportedSymbols: 10, smellScore: 18, functions: ['capitalize()', 'slugify()', 'truncate()', 'sanitize()', 'escapeHtml()'], variables: [], types: [] },
        { id: 'src/utils/array.utils.ts', type: 'file', label: 'array.utils.ts', path: 'src/utils/array.utils.ts', lines: 75, lang: 'typescript', size: 310, exportedSymbols: 7, smellScore: 12, functions: ['chunk()', 'unique()', 'groupBy()', 'sortBy()', 'shuffle()'], variables: [], types: [] },
        { id: 'src/utils/crypto.utils.ts', type: 'file', label: 'crypto.utils.ts', path: 'src/utils/crypto.utils.ts', lines: 105, lang: 'typescript', size: 350, exportedSymbols: 5, smellScore: 22, functions: ['hash()', 'encrypt()', 'decrypt()', 'generateToken()', 'verifySignature()'], variables: [], types: [] },
        
        // File nodes - tests/unit
        { id: 'tests/unit/user-service.test.ts', type: 'file', label: 'user-service.test.ts', path: 'tests/unit/user-service.test.ts', lines: 180, lang: 'typescript', size: 420, exportedSymbols: 0, smellScore: 25, functions: [], variables: [], types: [] },
        { id: 'tests/unit/auth-service.test.ts', type: 'file', label: 'auth-service.test.ts', path: 'tests/unit/auth-service.test.ts', lines: 145, lang: 'typescript', size: 380, exportedSymbols: 0, smellScore: 20, functions: [], variables: [], types: [] },
        { id: 'tests/unit/payment-service.test.ts', type: 'file', label: 'payment-service.test.ts', path: 'tests/unit/payment-service.test.ts', lines: 220, lang: 'typescript', size: 470, exportedSymbols: 0, smellScore: 32, functions: [], variables: [], types: [] },
        { id: 'tests/unit/email-service.test.ts', type: 'file', label: 'email-service.test.ts', path: 'tests/unit/email-service.test.ts', lines: 165, lang: 'typescript', size: 400, exportedSymbols: 0, smellScore: 22, functions: [], variables: [], types: [] },
        { id: 'tests/unit/validation.test.ts', type: 'file', label: 'validation.test.ts', path: 'tests/unit/validation.test.ts', lines: 135, lang: 'typescript', size: 370, exportedSymbols: 0, smellScore: 18, functions: [], variables: [], types: [] },
        { id: 'tests/unit/logger.test.ts', type: 'file', label: 'logger.test.ts', path: 'tests/unit/logger.test.ts', lines: 95, lang: 'typescript', size: 330, exportedSymbols: 0, smellScore: 12, functions: [], variables: [], types: [] },
        { id: 'tests/unit/crypto.test.ts', type: 'file', label: 'crypto.test.ts', path: 'tests/unit/crypto.test.ts', lines: 155, lang: 'typescript', size: 390, exportedSymbols: 0, smellScore: 20, functions: [], variables: [], types: [] },
        { id: 'tests/unit/date-utils.test.ts', type: 'file', label: 'date-utils.test.ts', path: 'tests/unit/date-utils.test.ts', lines: 125, lang: 'typescript', size: 360, exportedSymbols: 0, smellScore: 15, functions: [], variables: [], types: [] },
        
        // File nodes - tests/integration
        { id: 'tests/integration/auth-flow.test.ts', type: 'file', label: 'auth-flow.test.ts', path: 'tests/integration/auth-flow.test.ts', lines: 245, lang: 'typescript', size: 500, exportedSymbols: 0, smellScore: 38, functions: [], variables: [], types: [] },
        { id: 'tests/integration/order-flow.test.ts', type: 'file', label: 'order-flow.test.ts', path: 'tests/integration/order-flow.test.ts', lines: 285, lang: 'typescript', size: 560, exportedSymbols: 0, smellScore: 45, functions: [], variables: [], types: [] },
        { id: 'tests/integration/payment-flow.test.ts', type: 'file', label: 'payment-flow.test.ts', path: 'tests/integration/payment-flow.test.ts', lines: 265, lang: 'typescript', size: 530, exportedSymbols: 0, smellScore: 42, functions: [], variables: [], types: [] },
        { id: 'tests/integration/webhook-flow.test.ts', type: 'file', label: 'webhook-flow.test.ts', path: 'tests/integration/webhook-flow.test.ts', lines: 195, lang: 'typescript', size: 440, exportedSymbols: 0, smellScore: 28, functions: [], variables: [], types: [] },
        { id: 'tests/integration/search-flow.test.ts', type: 'file', label: 'search-flow.test.ts', path: 'tests/integration/search-flow.test.ts', lines: 175, lang: 'typescript', size: 410, exportedSymbols: 0, smellScore: 25, functions: [], variables: [], types: [] },
        { id: 'tests/integration/notification-flow.test.ts', type: 'file', label: 'notification-flow.test.ts', path: 'tests/integration/notification-flow.test.ts', lines: 155, lang: 'typescript', size: 390, exportedSymbols: 0, smellScore: 22, functions: [], variables: [], types: [] },
        { id: 'tests/integration/analytics-flow.test.ts', type: 'file', label: 'analytics-flow.test.ts', path: 'tests/integration/analytics-flow.test.ts', lines: 205, lang: 'typescript', size: 450, exportedSymbols: 0, smellScore: 32, functions: [], variables: [], types: [] },
        
        // File nodes - docs/api
        { id: 'docs/api/authentication.md', type: 'file', label: 'authentication.md', path: 'docs/api/authentication.md', lines: 125, lang: 'markdown', size: 360, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/api/users.md', type: 'file', label: 'users.md', path: 'docs/api/users.md', lines: 145, lang: 'markdown', size: 390, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/api/products.md', type: 'file', label: 'products.md', path: 'docs/api/products.md', lines: 165, lang: 'markdown', size: 410, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/api/orders.md', type: 'file', label: 'orders.md', path: 'docs/api/orders.md', lines: 185, lang: 'markdown', size: 440, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        
        // File nodes - docs/guides
        { id: 'docs/guides/getting-started.md', type: 'file', label: 'getting-started.md', path: 'docs/guides/getting-started.md', lines: 95, lang: 'markdown', size: 330, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/guides/deployment.md', type: 'file', label: 'deployment.md', path: 'docs/guides/deployment.md', lines: 135, lang: 'markdown', size: 370, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/guides/best-practices.md', type: 'file', label: 'best-practices.md', path: 'docs/guides/best-practices.md', lines: 175, lang: 'markdown', size: 420, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        { id: 'docs/guides/troubleshooting.md', type: 'file', label: 'troubleshooting.md', path: 'docs/guides/troubleshooting.md', lines: 155, lang: 'markdown', size: 390, exportedSymbols: 0, smellScore: 0, functions: [], variables: [], types: [] },
        
        // File nodes - src/services/external
        { id: 'src/services/external/stripe.service.ts', type: 'file', label: 'stripe.service.ts', path: 'src/services/external/stripe.service.ts', lines: 145, lang: 'typescript', size: 380, exportedSymbols: 4, smellScore: 28, functions: ['createPayment()', 'refund()', 'getCustomer()'], variables: [], types: [] },
        { id: 'src/services/external/sendgrid.service.ts', type: 'file', label: 'sendgrid.service.ts', path: 'src/services/external/sendgrid.service.ts', lines: 125, lang: 'typescript', size: 360, exportedSymbols: 3, smellScore: 22, functions: ['sendEmail()', 'sendBulk()'], variables: [], types: [] },
        { id: 'src/services/external/aws-s3.service.ts', type: 'file', label: 'aws-s3.service.ts', path: 'src/services/external/aws-s3.service.ts', lines: 165, lang: 'typescript', size: 400, exportedSymbols: 5, smellScore: 32, functions: ['upload()', 'download()', 'delete()'], variables: [], types: [] },
        { id: 'src/services/external/twilio.service.ts', type: 'file', label: 'twilio.service.ts', path: 'src/services/external/twilio.service.ts', lines: 105, lang: 'typescript', size: 340, exportedSymbols: 3, smellScore: 20, functions: ['sendSMS()', 'makeCall()'], variables: [], types: [] },
        
        // File nodes - src/services/internal
        { id: 'src/services/internal/queue.service.ts', type: 'file', label: 'queue.service.ts', path: 'src/services/internal/queue.service.ts', lines: 135, lang: 'typescript', size: 370, exportedSymbols: 4, smellScore: 25, functions: ['enqueue()', 'dequeue()', 'process()'], variables: [], types: [] },
        { id: 'src/services/internal/scheduler.service.ts', type: 'file', label: 'scheduler.service.ts', path: 'src/services/internal/scheduler.service.ts', lines: 155, lang: 'typescript', size: 390, exportedSymbols: 5, smellScore: 30, functions: ['schedule()', 'cancel()', 'run()'], variables: [], types: [] },
        { id: 'src/services/internal/worker.service.ts', type: 'file', label: 'worker.service.ts', path: 'src/services/internal/worker.service.ts', lines: 175, lang: 'typescript', size: 420, exportedSymbols: 4, smellScore: 35, functions: ['start()', 'stop()', 'execute()'], variables: [], types: [] },
        
        // File nodes - src/models/schemas
        { id: 'src/models/schemas/user.schema.ts', type: 'file', label: 'user.schema.ts', path: 'src/models/schemas/user.schema.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 1, smellScore: 10, functions: [], variables: [], types: ['UserSchema'] },
        { id: 'src/models/schemas/product.schema.ts', type: 'file', label: 'product.schema.ts', path: 'src/models/schemas/product.schema.ts', lines: 75, lang: 'typescript', size: 310, exportedSymbols: 1, smellScore: 12, functions: [], variables: [], types: ['ProductSchema'] },
        { id: 'src/models/schemas/order.schema.ts', type: 'file', label: 'order.schema.ts', path: 'src/models/schemas/order.schema.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 1, smellScore: 15, functions: [], variables: [], types: ['OrderSchema'] },
        
        // File nodes - src/models/validators
        { id: 'src/models/validators/user.validator.ts', type: 'file', label: 'user.validator.ts', path: 'src/models/validators/user.validator.ts', lines: 95, lang: 'typescript', size: 330, exportedSymbols: 3, smellScore: 18, functions: ['validateUser()', 'validateEmail()'], variables: [], types: [] },
        { id: 'src/models/validators/product.validator.ts', type: 'file', label: 'product.validator.ts', path: 'src/models/validators/product.validator.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 2, smellScore: 15, functions: ['validateProduct()'], variables: [], types: [] },
        { id: 'src/models/validators/order.validator.ts', type: 'file', label: 'order.validator.ts', path: 'src/models/validators/order.validator.ts', lines: 105, lang: 'typescript', size: 350, exportedSymbols: 3, smellScore: 22, functions: ['validateOrder()', 'validateItems()'], variables: [], types: [] },
        
        // File nodes - src/utils/formatters
        { id: 'src/utils/formatters/date.formatter.ts', type: 'file', label: 'date.formatter.ts', path: 'src/utils/formatters/date.formatter.ts', lines: 75, lang: 'typescript', size: 310, exportedSymbols: 5, smellScore: 12, functions: ['formatDate()', 'formatTime()', 'formatDateTime()'], variables: [], types: [] },
        { id: 'src/utils/formatters/number.formatter.ts', type: 'file', label: 'number.formatter.ts', path: 'src/utils/formatters/number.formatter.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 4, smellScore: 10, functions: ['formatCurrency()', 'formatPercent()'], variables: [], types: [] },
        { id: 'src/utils/formatters/string.formatter.ts', type: 'file', label: 'string.formatter.ts', path: 'src/utils/formatters/string.formatter.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 6, smellScore: 15, functions: ['capitalize()', 'truncate()', 'slugify()'], variables: [], types: [] },
        { id: 'src/utils/formatters/json.formatter.ts', type: 'file', label: 'json.formatter.ts', path: 'src/utils/formatters/json.formatter.ts', lines: 55, lang: 'typescript', size: 270, exportedSymbols: 3, smellScore: 8, functions: ['prettify()', 'minify()'], variables: [], types: [] },
        
        // File nodes - src/utils/parsers
        { id: 'src/utils/parsers/csv.parser.ts', type: 'file', label: 'csv.parser.ts', path: 'src/utils/parsers/csv.parser.ts', lines: 125, lang: 'typescript', size: 360, exportedSymbols: 4, smellScore: 25, functions: ['parseCSV()', 'toCSV()'], variables: [], types: [] },
        { id: 'src/utils/parsers/xml.parser.ts', type: 'file', label: 'xml.parser.ts', path: 'src/utils/parsers/xml.parser.ts', lines: 145, lang: 'typescript', size: 380, exportedSymbols: 4, smellScore: 30, functions: ['parseXML()', 'toXML()'], variables: [], types: [] },
        { id: 'src/utils/parsers/json.parser.ts', type: 'file', label: 'json.parser.ts', path: 'src/utils/parsers/json.parser.ts', lines: 95, lang: 'typescript', size: 330, exportedSymbols: 3, smellScore: 18, functions: ['parseJSON()', 'stringify()'], variables: [], types: [] },
        
        // File nodes - src/controllers/api
        { id: 'src/controllers/api/v1.controller.ts', type: 'file', label: 'v1.controller.ts', path: 'src/controllers/api/v1.controller.ts', lines: 185, lang: 'typescript', size: 440, exportedSymbols: 1, smellScore: 35, functions: [], variables: [], types: [] },
        { id: 'src/controllers/api/v2.controller.ts', type: 'file', label: 'v2.controller.ts', path: 'src/controllers/api/v2.controller.ts', lines: 205, lang: 'typescript', size: 470, exportedSymbols: 1, smellScore: 40, functions: [], variables: [], types: [] },
        { id: 'src/controllers/api/graphql.controller.ts', type: 'file', label: 'graphql.controller.ts', path: 'src/controllers/api/graphql.controller.ts', lines: 245, lang: 'typescript', size: 520, exportedSymbols: 1, smellScore: 48, functions: [], variables: [], types: [] },
        { id: 'src/controllers/api/rest.controller.ts', type: 'file', label: 'rest.controller.ts', path: 'src/controllers/api/rest.controller.ts', lines: 165, lang: 'typescript', size: 400, exportedSymbols: 1, smellScore: 32, functions: [], variables: [], types: [] },
        { id: 'src/controllers/api/health.controller.ts', type: 'file', label: 'health.controller.ts', path: 'src/controllers/api/health.controller.ts', lines: 85, lang: 'typescript', size: 320, exportedSymbols: 1, smellScore: 15, functions: [], variables: [], types: [] },
        
        // File nodes - src/controllers/webhooks
        { id: 'src/controllers/webhooks/stripe.webhook.ts', type: 'file', label: 'stripe.webhook.ts', path: 'src/controllers/webhooks/stripe.webhook.ts', lines: 145, lang: 'typescript', size: 380, exportedSymbols: 1, smellScore: 28, functions: [], variables: [], types: [] },
        { id: 'src/controllers/webhooks/github.webhook.ts', type: 'file', label: 'github.webhook.ts', path: 'src/controllers/webhooks/github.webhook.ts', lines: 125, lang: 'typescript', size: 360, exportedSymbols: 1, smellScore: 24, functions: [], variables: [], types: [] },
        { id: 'src/controllers/webhooks/slack.webhook.ts', type: 'file', label: 'slack.webhook.ts', path: 'src/controllers/webhooks/slack.webhook.ts', lines: 105, lang: 'typescript', size: 340, exportedSymbols: 1, smellScore: 20, functions: [], variables: [], types: [] },
        
        // File nodes - src/types/dto
        { id: 'src/types/dto/create-user.dto.ts', type: 'file', label: 'create-user.dto.ts', path: 'src/types/dto/create-user.dto.ts', lines: 45, lang: 'typescript', size: 250, exportedSymbols: 1, smellScore: 5, functions: [], variables: [], types: ['CreateUserDTO'] },
        { id: 'src/types/dto/update-user.dto.ts', type: 'file', label: 'update-user.dto.ts', path: 'src/types/dto/update-user.dto.ts', lines: 40, lang: 'typescript', size: 240, exportedSymbols: 1, smellScore: 5, functions: [], variables: [], types: ['UpdateUserDTO'] },
        { id: 'src/types/dto/create-product.dto.ts', type: 'file', label: 'create-product.dto.ts', path: 'src/types/dto/create-product.dto.ts', lines: 55, lang: 'typescript', size: 270, exportedSymbols: 1, smellScore: 7, functions: [], variables: [], types: ['CreateProductDTO'] },
        { id: 'src/types/dto/create-order.dto.ts', type: 'file', label: 'create-order.dto.ts', path: 'src/types/dto/create-order.dto.ts', lines: 65, lang: 'typescript', size: 290, exportedSymbols: 1, smellScore: 10, functions: [], variables: [], types: ['CreateOrderDTO'] },
        { id: 'src/types/dto/payment.dto.ts', type: 'file', label: 'payment.dto.ts', path: 'src/types/dto/payment.dto.ts', lines: 50, lang: 'typescript', size: 260, exportedSymbols: 2, smellScore: 7, functions: [], variables: [], types: ['PaymentDTO', 'RefundDTO'] },
        
        // File nodes - src/types/enums
        { id: 'src/types/enums/user-role.enum.ts', type: 'file', label: 'user-role.enum.ts', path: 'src/types/enums/user-role.enum.ts', lines: 25, lang: 'typescript', size: 210, exportedSymbols: 1, smellScore: 2, functions: [], variables: [], types: ['UserRole'] },
        { id: 'src/types/enums/order-status.enum.ts', type: 'file', label: 'order-status.enum.ts', path: 'src/types/enums/order-status.enum.ts', lines: 30, lang: 'typescript', size: 220, exportedSymbols: 1, smellScore: 3, functions: [], variables: [], types: ['OrderStatus'] },
        { id: 'src/types/enums/payment-status.enum.ts', type: 'file', label: 'payment-status.enum.ts', path: 'src/types/enums/payment-status.enum.ts', lines: 28, lang: 'typescript', size: 216, exportedSymbols: 1, smellScore: 3, functions: [], variables: [], types: ['PaymentStatus'] },
        { id: 'src/types/enums/notification-type.enum.ts', type: 'file', label: 'notification-type.enum.ts', path: 'src/types/enums/notification-type.enum.ts', lines: 32, lang: 'typescript', size: 224, exportedSymbols: 1, smellScore: 3, functions: [], variables: [], types: ['NotificationType'] },
        
        // File nodes - tests/unit/services
        { id: 'tests/unit/services/stripe.test.ts', type: 'file', label: 'stripe.test.ts', path: 'tests/unit/services/stripe.test.ts', lines: 165, lang: 'typescript', size: 400, exportedSymbols: 0, smellScore: 22, functions: [], variables: [], types: [] },
        { id: 'tests/unit/services/sendgrid.test.ts', type: 'file', label: 'sendgrid.test.ts', path: 'tests/unit/services/sendgrid.test.ts', lines: 145, lang: 'typescript', size: 380, exportedSymbols: 0, smellScore: 20, functions: [], variables: [], types: [] },
        { id: 'tests/unit/services/queue.test.ts', type: 'file', label: 'queue.test.ts', path: 'tests/unit/services/queue.test.ts', lines: 155, lang: 'typescript', size: 390, exportedSymbols: 0, smellScore: 21, functions: [], variables: [], types: [] },
        { id: 'tests/unit/services/scheduler.test.ts', type: 'file', label: 'scheduler.test.ts', path: 'tests/unit/services/scheduler.test.ts', lines: 175, lang: 'typescript', size: 420, exportedSymbols: 0, smellScore: 25, functions: [], variables: [], types: [] },
        { id: 'tests/unit/services/worker.test.ts', type: 'file', label: 'worker.test.ts', path: 'tests/unit/services/worker.test.ts', lines: 185, lang: 'typescript', size: 440, exportedSymbols: 0, smellScore: 28, functions: [], variables: [], types: [] },
        
        // File nodes - tests/unit/utils
        { id: 'tests/unit/utils/formatters.test.ts', type: 'file', label: 'formatters.test.ts', path: 'tests/unit/utils/formatters.test.ts', lines: 135, lang: 'typescript', size: 370, exportedSymbols: 0, smellScore: 18, functions: [], variables: [], types: [] },
        { id: 'tests/unit/utils/parsers.test.ts', type: 'file', label: 'parsers.test.ts', path: 'tests/unit/utils/parsers.test.ts', lines: 155, lang: 'typescript', size: 390, exportedSymbols: 0, smellScore: 22, functions: [], variables: [], types: [] },
        { id: 'tests/unit/utils/string-utils.test.ts', type: 'file', label: 'string-utils.test.ts', path: 'tests/unit/utils/string-utils.test.ts', lines: 125, lang: 'typescript', size: 360, exportedSymbols: 0, smellScore: 17, functions: [], variables: [], types: [] },
        { id: 'tests/unit/utils/array-utils.test.ts', type: 'file', label: 'array-utils.test.ts', path: 'tests/unit/utils/array-utils.test.ts', lines: 115, lang: 'typescript', size: 350, exportedSymbols: 0, smellScore: 15, functions: [], variables: [], types: [] },
        
        // File nodes - tests/integration/api
        { id: 'tests/integration/api/v1-endpoints.test.ts', type: 'file', label: 'v1-endpoints.test.ts', path: 'tests/integration/api/v1-endpoints.test.ts', lines: 245, lang: 'typescript', size: 500, exportedSymbols: 0, smellScore: 40, functions: [], variables: [], types: [] },
        { id: 'tests/integration/api/v2-endpoints.test.ts', type: 'file', label: 'v2-endpoints.test.ts', path: 'tests/integration/api/v2-endpoints.test.ts', lines: 265, lang: 'typescript', size: 530, exportedSymbols: 0, smellScore: 45, functions: [], variables: [], types: [] },
        { id: 'tests/integration/api/graphql-queries.test.ts', type: 'file', label: 'graphql-queries.test.ts', path: 'tests/integration/api/graphql-queries.test.ts', lines: 285, lang: 'typescript', size: 560, exportedSymbols: 0, smellScore: 48, functions: [], variables: [], types: [] },
        { id: 'tests/integration/api/rest-api.test.ts', type: 'file', label: 'rest-api.test.ts', path: 'tests/integration/api/rest-api.test.ts', lines: 225, lang: 'typescript', size: 480, exportedSymbols: 0, smellScore: 38, functions: [], variables: [], types: [] },
        
        // File nodes - tests/integration/e2e
        { id: 'tests/integration/e2e/user-journey.test.ts', type: 'file', label: 'user-journey.test.ts', path: 'tests/integration/e2e/user-journey.test.ts', lines: 305, lang: 'typescript', size: 590, exportedSymbols: 0, smellScore: 52, functions: [], variables: [], types: [] },
        { id: 'tests/integration/e2e/checkout-flow.test.ts', type: 'file', label: 'checkout-flow.test.ts', path: 'tests/integration/e2e/checkout-flow.test.ts', lines: 325, lang: 'typescript', size: 620, exportedSymbols: 0, smellScore: 55, functions: [], variables: [], types: [] },
        { id: 'tests/integration/e2e/admin-workflow.test.ts', type: 'file', label: 'admin-workflow.test.ts', path: 'tests/integration/e2e/admin-workflow.test.ts', lines: 285, lang: 'typescript', size: 560, exportedSymbols: 0, smellScore: 48, functions: [], variables: [], types: [] }
      ],
      edges: [
        // Directory hierarchy - src subdirectories
        { source: 'dir:src', target: 'dir:src/services', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/models', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/utils', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/controllers', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/middleware', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/config', type: 'contains' },
        { source: 'dir:src', target: 'dir:src/types', type: 'contains' },
        
        // Directory hierarchy - tests subdirectories
        { source: 'dir:tests', target: 'dir:tests/unit', type: 'contains' },
        { source: 'dir:tests', target: 'dir:tests/integration', type: 'contains' },
        
        // Directory hierarchy - docs subdirectories
        { source: 'dir:docs', target: 'dir:docs/api', type: 'contains' },
        { source: 'dir:docs', target: 'dir:docs/guides', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under src/services
        { source: 'dir:src/services', target: 'dir:src/services/external', type: 'contains' },
        { source: 'dir:src/services', target: 'dir:src/services/internal', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under src/models
        { source: 'dir:src/models', target: 'dir:src/models/schemas', type: 'contains' },
        { source: 'dir:src/models', target: 'dir:src/models/validators', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under src/utils
        { source: 'dir:src/utils', target: 'dir:src/utils/formatters', type: 'contains' },
        { source: 'dir:src/utils', target: 'dir:src/utils/parsers', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under src/controllers
        { source: 'dir:src/controllers', target: 'dir:src/controllers/api', type: 'contains' },
        { source: 'dir:src/controllers', target: 'dir:src/controllers/webhooks', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under src/types
        { source: 'dir:src/types', target: 'dir:src/types/dto', type: 'contains' },
        { source: 'dir:src/types', target: 'dir:src/types/enums', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under tests/unit
        { source: 'dir:tests/unit', target: 'dir:tests/unit/services', type: 'contains' },
        { source: 'dir:tests/unit', target: 'dir:tests/unit/utils', type: 'contains' },
        
        // Directory hierarchy - level 2 subdirectories under tests/integration
        { source: 'dir:tests/integration', target: 'dir:tests/integration/api', type: 'contains' },
        { source: 'dir:tests/integration', target: 'dir:tests/integration/e2e', type: 'contains' },
        
        // Directory to file containment
        { source: 'dir:src/services', target: 'src/services/user-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/auth-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/email-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/payment-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/notification-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/storage-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/cache-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/analytics-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/search-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/webhook-service.ts', type: 'contains' },
        { source: 'dir:src/services', target: 'src/services/rate-limiter-service.ts', type: 'contains' },
        
        // Directory to file - src/models
        { source: 'dir:src/models', target: 'src/models/user.model.ts', type: 'contains' },
        { source: 'dir:src/models', target: 'src/models/product.model.ts', type: 'contains' },
        { source: 'dir:src/models', target: 'src/models/order.model.ts', type: 'contains' },
        { source: 'dir:src/models', target: 'src/models/payment.model.ts', type: 'contains' },
        { source: 'dir:src/models', target: 'src/models/notification.model.ts', type: 'contains' },
        
        // Directory to file - src/utils
        { source: 'dir:src/utils', target: 'src/utils/validation.ts', type: 'contains' },
        { source: 'dir:src/utils', target: 'src/utils/logger.ts', type: 'contains' },
        { source: 'dir:src/utils', target: 'src/utils/date.utils.ts', type: 'contains' },
        { source: 'dir:src/utils', target: 'src/utils/string.utils.ts', type: 'contains' },
        { source: 'dir:src/utils', target: 'src/utils/array.utils.ts', type: 'contains' },
        { source: 'dir:src/utils', target: 'src/utils/crypto.utils.ts', type: 'contains' },
        
        // Directory to file - src/middleware
        { source: 'dir:src/middleware', target: 'src/middleware/auth.middleware.ts', type: 'contains' },
        { source: 'dir:src/middleware', target: 'src/middleware/validation.middleware.ts', type: 'contains' },
        { source: 'dir:src/middleware', target: 'src/middleware/error.middleware.ts', type: 'contains' },
        { source: 'dir:src/middleware', target: 'src/middleware/rate-limit.middleware.ts', type: 'contains' },
        { source: 'dir:src/middleware', target: 'src/middleware/cors.middleware.ts', type: 'contains' },
        
        // Directory to file - src/config
        { source: 'dir:src/config', target: 'src/config/database.config.ts', type: 'contains' },
        { source: 'dir:src/config', target: 'src/config/app.config.ts', type: 'contains' },
        { source: 'dir:src/config', target: 'src/config/auth.config.ts', type: 'contains' },
        { source: 'dir:src/config', target: 'src/config/email.config.ts', type: 'contains' },
        
        // Directory to file - src/types
        { source: 'dir:src/types', target: 'src/types/user.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/product.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/order.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/payment.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/api.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/common.types.ts', type: 'contains' },
        { source: 'dir:src/types', target: 'src/types/validation.types.ts', type: 'contains' },
        
        // Directory to file - tests/unit
        { source: 'dir:tests/unit', target: 'tests/unit/user-service.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/auth-service.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/payment-service.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/email-service.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/validation.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/logger.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/crypto.test.ts', type: 'contains' },
        { source: 'dir:tests/unit', target: 'tests/unit/date-utils.test.ts', type: 'contains' },
        
        // Directory to file - tests/integration
        { source: 'dir:tests/integration', target: 'tests/integration/auth-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/order-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/payment-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/webhook-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/search-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/notification-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration', target: 'tests/integration/analytics-flow.test.ts', type: 'contains' },
        
        // Directory to file - docs/api
        { source: 'dir:docs/api', target: 'docs/api/authentication.md', type: 'contains' },
        { source: 'dir:docs/api', target: 'docs/api/users.md', type: 'contains' },
        { source: 'dir:docs/api', target: 'docs/api/products.md', type: 'contains' },
        { source: 'dir:docs/api', target: 'docs/api/orders.md', type: 'contains' },
        
        // Directory to file - docs/guides
        { source: 'dir:docs/guides', target: 'docs/guides/getting-started.md', type: 'contains' },
        { source: 'dir:docs/guides', target: 'docs/guides/deployment.md', type: 'contains' },
        { source: 'dir:docs/guides', target: 'docs/guides/best-practices.md', type: 'contains' },
        { source: 'dir:docs/guides', target: 'docs/guides/troubleshooting.md', type: 'contains' },
        
        // Directory to file - src/services/external
        { source: 'dir:src/services/external', target: 'src/services/external/stripe.service.ts', type: 'contains' },
        { source: 'dir:src/services/external', target: 'src/services/external/sendgrid.service.ts', type: 'contains' },
        { source: 'dir:src/services/external', target: 'src/services/external/aws-s3.service.ts', type: 'contains' },
        { source: 'dir:src/services/external', target: 'src/services/external/twilio.service.ts', type: 'contains' },
        
        // Directory to file - src/services/internal
        { source: 'dir:src/services/internal', target: 'src/services/internal/queue.service.ts', type: 'contains' },
        { source: 'dir:src/services/internal', target: 'src/services/internal/scheduler.service.ts', type: 'contains' },
        { source: 'dir:src/services/internal', target: 'src/services/internal/worker.service.ts', type: 'contains' },
        
        // Directory to file - src/models/schemas
        { source: 'dir:src/models/schemas', target: 'src/models/schemas/user.schema.ts', type: 'contains' },
        { source: 'dir:src/models/schemas', target: 'src/models/schemas/product.schema.ts', type: 'contains' },
        { source: 'dir:src/models/schemas', target: 'src/models/schemas/order.schema.ts', type: 'contains' },
        
        // Directory to file - src/models/validators
        { source: 'dir:src/models/validators', target: 'src/models/validators/user.validator.ts', type: 'contains' },
        { source: 'dir:src/models/validators', target: 'src/models/validators/product.validator.ts', type: 'contains' },
        { source: 'dir:src/models/validators', target: 'src/models/validators/order.validator.ts', type: 'contains' },
        
        // Directory to file - src/utils/formatters
        { source: 'dir:src/utils/formatters', target: 'src/utils/formatters/date.formatter.ts', type: 'contains' },
        { source: 'dir:src/utils/formatters', target: 'src/utils/formatters/number.formatter.ts', type: 'contains' },
        { source: 'dir:src/utils/formatters', target: 'src/utils/formatters/string.formatter.ts', type: 'contains' },
        { source: 'dir:src/utils/formatters', target: 'src/utils/formatters/json.formatter.ts', type: 'contains' },
        
        // Directory to file - src/utils/parsers
        { source: 'dir:src/utils/parsers', target: 'src/utils/parsers/csv.parser.ts', type: 'contains' },
        { source: 'dir:src/utils/parsers', target: 'src/utils/parsers/xml.parser.ts', type: 'contains' },
        { source: 'dir:src/utils/parsers', target: 'src/utils/parsers/json.parser.ts', type: 'contains' },
        
        // Directory to file - src/controllers/api
        { source: 'dir:src/controllers/api', target: 'src/controllers/api/v1.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers/api', target: 'src/controllers/api/v2.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers/api', target: 'src/controllers/api/graphql.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers/api', target: 'src/controllers/api/rest.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers/api', target: 'src/controllers/api/health.controller.ts', type: 'contains' },
        
        // Directory to file - src/controllers/webhooks
        { source: 'dir:src/controllers/webhooks', target: 'src/controllers/webhooks/stripe.webhook.ts', type: 'contains' },
        { source: 'dir:src/controllers/webhooks', target: 'src/controllers/webhooks/github.webhook.ts', type: 'contains' },
        { source: 'dir:src/controllers/webhooks', target: 'src/controllers/webhooks/slack.webhook.ts', type: 'contains' },
        
        // Directory to file - src/types/dto
        { source: 'dir:src/types/dto', target: 'src/types/dto/create-user.dto.ts', type: 'contains' },
        { source: 'dir:src/types/dto', target: 'src/types/dto/update-user.dto.ts', type: 'contains' },
        { source: 'dir:src/types/dto', target: 'src/types/dto/create-product.dto.ts', type: 'contains' },
        { source: 'dir:src/types/dto', target: 'src/types/dto/create-order.dto.ts', type: 'contains' },
        { source: 'dir:src/types/dto', target: 'src/types/dto/payment.dto.ts', type: 'contains' },
        
        // Directory to file - src/types/enums
        { source: 'dir:src/types/enums', target: 'src/types/enums/user-role.enum.ts', type: 'contains' },
        { source: 'dir:src/types/enums', target: 'src/types/enums/order-status.enum.ts', type: 'contains' },
        { source: 'dir:src/types/enums', target: 'src/types/enums/payment-status.enum.ts', type: 'contains' },
        { source: 'dir:src/types/enums', target: 'src/types/enums/notification-type.enum.ts', type: 'contains' },
        
        // Directory to file - tests/unit/services
        { source: 'dir:tests/unit/services', target: 'tests/unit/services/stripe.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/services', target: 'tests/unit/services/sendgrid.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/services', target: 'tests/unit/services/queue.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/services', target: 'tests/unit/services/scheduler.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/services', target: 'tests/unit/services/worker.test.ts', type: 'contains' },
        
        // Directory to file - tests/unit/utils
        { source: 'dir:tests/unit/utils', target: 'tests/unit/utils/formatters.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/utils', target: 'tests/unit/utils/parsers.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/utils', target: 'tests/unit/utils/string-utils.test.ts', type: 'contains' },
        { source: 'dir:tests/unit/utils', target: 'tests/unit/utils/array-utils.test.ts', type: 'contains' },
        
        // Directory to file - tests/integration/api
        { source: 'dir:tests/integration/api', target: 'tests/integration/api/v1-endpoints.test.ts', type: 'contains' },
        { source: 'dir:tests/integration/api', target: 'tests/integration/api/v2-endpoints.test.ts', type: 'contains' },
        { source: 'dir:tests/integration/api', target: 'tests/integration/api/graphql-queries.test.ts', type: 'contains' },
        { source: 'dir:tests/integration/api', target: 'tests/integration/api/rest-api.test.ts', type: 'contains' },
        
        // Directory to file - tests/integration/e2e
        { source: 'dir:tests/integration/e2e', target: 'tests/integration/e2e/user-journey.test.ts', type: 'contains' },
        { source: 'dir:tests/integration/e2e', target: 'tests/integration/e2e/checkout-flow.test.ts', type: 'contains' },
        { source: 'dir:tests/integration/e2e', target: 'tests/integration/e2e/admin-workflow.test.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/auth.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/user.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/product.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/order.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/payment.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/notification.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/analytics.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/search.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/webhook.controller.ts', type: 'contains' },
        { source: 'dir:src/controllers', target: 'src/controllers/admin.controller.ts', type: 'contains' }
      ]
    };
  </script>
  
  <!-- Include the actual files map visualization code from the extension -->
  <script>
    // This is the exact same JavaScript code from files-map-panel.ts getHtmlContent()
    // but adapted to work standalone without VSCode API dependencies
    
    let graphData = null;
    let simulation = null;
    let svg = null;
    let g = null;
    let zoom = null;
    let colorMode = 'directory';
    let searchQuery = '';
    let savedLayout = {};
    let tooltipTimeout = null;
    let tooltip = null;
    let filteredNodes = []; // Track filtered nodes for navigation
    let currentFilteredIndex = -1; // Current index in filtered nodes
    let isDragging = false;
    let isResizing = false; // Track if window is being resized
    let currentSmellDetailsNode = null;
    let currentCenteredNode = null;
    let updateDirectorySizes = null;
    
    // 50 predefined distinct colors for directories
    const directoryColors = [
      '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F',
      '#BB8FCE', '#85C1E2', '#F8B739', '#52B788', '#E63946', '#06FFA5',
      '#FFB4A2', '#B5838D', '#6C5B7B', '#C06C84', '#F67280', '#355C7D',
      '#99B898', '#FECEAB', '#FF8C94', '#5DADE2', '#F39C12', '#A569BD',
      '#48C9B0', '#F4D03F', '#EC7063', '#85929E', '#58D68D', '#AF7AC5',
      '#FF6F91', '#C44569', '#F8B500', '#78E08F', '#60A3BC', '#EA8685',
      '#FD79A8', '#FDCB6E', '#6C5CE7', '#00B894', '#00CEC9', '#0984E3',
      '#A29BFE', '#FF7675', '#74B9FF', '#55EFC4', '#FAB1A0', '#DFE6E9',
      '#FD79A8', '#FDCB6E', '#E17055', '#81ECEC', '#FFEAA7', '#DFE4EA',
      '#FF6348', '#FF4757', '#2ED573', '#1E90FF', '#FFA502', '#FF6348',
      '#5F27CD', '#00D2D3', '#FF9FF3', '#54A0FF', '#48DBFB', '#01A3A4'
    ];
    
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }
    
    function getDirectoryColor(dirPath) {
      const hash = hashString(dirPath);
      const colorIndex = hash % directoryColors.length;
      return directoryColors[colorIndex];
    }
    
    function getFileColorByDirectory(filePath) {
      if (!filePath) return directoryColors[0];
      const lastSlashIndex = filePath.lastIndexOf('/');
      if (lastSlashIndex === -1) return directoryColors[0];
      const dirPath = filePath.substring(0, lastSlashIndex);
      if (!dirPath) return directoryColors[0];
      return getDirectoryColor(dirPath);
    }
    
    function getFileColorBySymbols(exportedSymbols) {
      if (exportedSymbols === 0) return '#999';
      if (exportedSymbols <= 3) return '#FFD700';
      if (exportedSymbols <= 6) return '#ADFF2F';
      if (exportedSymbols <= 9) return '#7FFF00';
      return '#00D084';
    }
    
    function getFileColorBySmell(smellScore) {
      if (smellScore <= 20) return '#00D084';
      if (smellScore <= 40) return '#55EFC4';
      if (smellScore <= 60) return '#FDCB6E';
      if (smellScore <= 80) return '#FF7675';
      return '#D63031';
    }
    
    function getFileColor(node) {
      if (colorMode === 'directory') {
        return getFileColorByDirectory(node.path);
      } else if (colorMode === 'smell') {
        return getFileColorBySmell(node.smellScore);
      } else {
        return getFileColorBySymbols(node.exportedSymbols);
      }
    }
    
    function getDirBoxColor(dirPath) {
      if (colorMode === 'directory') {
        return getDirectoryColor(dirPath);
      } else {
        return '#fff';
      }
    }
    
    function getTextColor(node) {
      if (colorMode === 'directory') {
        return '#000';
      } else if (colorMode === 'smell') {
        const smellScore = node.smellScore;
        if (smellScore <= 40) return '#000';
        if (smellScore <= 80) return '#333';
        return '#fff';
      } else {
        const exportedSymbols = node.exportedSymbols;
        if (exportedSymbols === 0) return '#d4d4d4';
        if (exportedSymbols <= 9) return '#333';
        return '#d4d4d4';
      }
    }
    
    const edgeColors = {
      imports: '#4a9eff',
      calls: '#4caf50',
      inherits: '#ff9800',
      defines: '#9c27b0',
      modifies: '#f44336'
    };
    
    function init() {
      svg = d3.select('#graph');
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      
      svg.attr('width', width).attr('height', height);
      
      zoom = d3.zoom()
        .scaleExtent([0.01, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
          if (updateDirectorySizes) {
            updateDirectorySizes(event.transform.k);
          }
          updateCenteredElements();
          // Update zoom indicator
          const zoomPercent = Math.round(event.transform.k * 100);
          d3.select('#zoom-indicator').text(zoomPercent + '%');
        });
      
      svg.call(zoom);
      
      svg.on('click', (event) => {
        if (event.target.tagName === 'svg') {
          hideSmellDetails();
        }
      });
      
      g = svg.append('g');
      tooltip = document.getElementById('tooltip');
      
      const searchBox = document.getElementById('search-box');
      searchBox.addEventListener('input', (e) => {
        searchQuery = e.target.value.toLowerCase();
        applySearchFilter();
      });
      
      // Add keyboard navigation for filtered results (Ctrl+N)
      document.addEventListener('keydown', (e) => {
        // Check for Ctrl+N (or Cmd+N on Mac)
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          navigateToNextFilteredNode();
        }
      });
      
      const colorModeSelect = document.getElementById('color-mode-select');
      colorModeSelect.addEventListener('change', (e) => {
        const mode = e.target.value;
        if (mode !== colorMode) {
          colorMode = mode;
          updateColors();
          checkAndShowCenteredFile();
        }
      });
      
      const defs = svg.append('defs');
      for (const [type, color] of Object.entries(edgeColors)) {
        defs.append('marker')
          .attr('id', `arrow-${type}`)
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 20)
          .attr('refY', 0)
          .attr('markerWidth', 6)
          .attr('markerHeight', 6)
          .attr('orient', 'auto')
          .append('path')
          .attr('d', 'M0,-5L10,0L0,5')
          .attr('class', 'arrow')
          .style('fill', color);
      }
      
      vscode.postMessage({ type: 'ready' });
    }
    
    function showTooltip(event, node) {
      if (!tooltip) return;
      
      const filenameEl = tooltip.querySelector('.tooltip-filename');
      const linesEl = tooltip.querySelector('.tooltip-lines');
      
      if (node.type === 'copy-button') {
        filenameEl.textContent = node.label;
        linesEl.textContent = '';
      } else if (node.type === 'pin-indicator') {
        filenameEl.textContent = node.label;
        linesEl.textContent = '';
      } else if (node.type === 'file') {
        filenameEl.textContent = node.label;
        let details = node.lines + ' lines';
        if (colorMode === 'smell') {
          const score = node.smellScore || 0;
          let rating = 'Clean';
          if (score > 80) rating = 'High';
          else if (score > 60) rating = 'Significant';
          else if (score > 40) rating = 'Moderate';
          else if (score > 20) rating = 'Minor';
          details += ' | Smell: ' + rating + ' (' + score + ')';
        }
        linesEl.textContent = details;
      } else if (node.type === 'directory') {
        filenameEl.textContent = node.path;
        linesEl.textContent = '';
      }
      
      updateTooltipPosition(event);
      tooltip.classList.add('visible');
    }
    
    function updateTooltipPosition(event) {
      if (!tooltip) return;
      const offset = 10;
      tooltip.style.left = (event.pageX + offset) + 'px';
      tooltip.style.top = (event.pageY + offset) + 'px';
    }
    
    function hideTooltip() {
      if (!tooltip) return;
      tooltip.classList.remove('visible');
    }
    
    let currentSymbolListNode = null;
    let symbolListHideTimeout = null;
    
    function showSymbolList(node, symbolType) {
      if (symbolListHideTimeout) {
        clearTimeout(symbolListHideTimeout);
        symbolListHideTimeout = null;
      }
      
      hideTooltip();
      if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
      }
      
      if (currentSymbolListNode === node.id + '-' + symbolType) {
        return;
      }
      
      d3.selectAll('.symbol-list-group').remove();
      currentSymbolListNode = node.id + '-' + symbolType;
      
      const symbols = symbolType === 'functions' ? node.functions : 
                      symbolType === 'variables' ? node.variables : 
                      node.types;
      if (symbols.length === 0) return;
      
      const listGroup = g.append('g')
        .attr('class', 'symbol-list-group')
        .attr('transform', `translate(${node.x}, ${node.y})`);
      
      const fileBoxHeight = node.size / 2;
      const tooltipHeight = 200;
      
      const longestSymbol = symbols.reduce((max, s) => s.length > max.length ? s : max, '');
      const estimatedWidth = Math.max(
        longestSymbol.length * 5.4 + 30,
        80
      );
      const tooltipWidth = Math.min(Math.ceil(estimatedWidth), 200);
      
      const squareOffsetFromBox = 15;
      const squareSize = 16;
      const gapFromSquare = 15;
      
      let offsetX, offsetY;
      
      if (symbolType === 'variables') {
        offsetX = -node.size / 2 - squareOffsetFromBox - squareSize / 2 - gapFromSquare - tooltipWidth;
        offsetY = -fileBoxHeight / 2;
      } else if (symbolType === 'functions') {
        offsetX = node.size / 2 + squareOffsetFromBox + squareSize / 2 + gapFromSquare;
        offsetY = -fileBoxHeight / 2;
      } else {
        offsetX = -tooltipWidth / 2;
        const iconCenterY = -fileBoxHeight / 2 - squareOffsetFromBox;
        const iconTopY = iconCenterY - squareSize / 2;
        const estimatedContentHeight = Math.min(symbols.length * 10 + 12, 120);
        offsetY = iconTopY - gapFromSquare - estimatedContentHeight - 5;
      }
      
      const symbolsHTML = symbols.map(s => `<div class="symbol-list-item">${s}</div>`).join('');
      const panelHTML = `<div class="symbol-list-panel">${symbolsHTML}</div>`;
      
      const foreignObj = listGroup.append('foreignObject')
        .attr('x', offsetX)
        .attr('y', offsetY)
        .attr('width', tooltipWidth)
        .attr('height', tooltipHeight)
        .style('pointer-events', 'all')
        .style('overflow', 'visible')
        .html(panelHTML);
      
      setTimeout(() => {
        const panel = foreignObj.node().querySelector('.symbol-list-panel');
        if (panel) {
          panel.addEventListener('mouseenter', function() {
            if (symbolListHideTimeout) {
              clearTimeout(symbolListHideTimeout);
              symbolListHideTimeout = null;
            }
          });
          
          panel.addEventListener('mouseleave', function() {
            hideSymbolListWithDelay();
          });
          
          panel.addEventListener('wheel', function(e) {
            e.stopPropagation();
          });
        }
      }, 10);
    }
    
    function hideSymbolListWithDelay() {
      symbolListHideTimeout = setTimeout(() => {
        d3.selectAll('.symbol-list-group').remove();
        currentSymbolListNode = null;
        symbolListHideTimeout = null;
      }, 300);
    }
    
    function hideSymbolListImmediately() {
      if (symbolListHideTimeout) {
        clearTimeout(symbolListHideTimeout);
        symbolListHideTimeout = null;
      }
      d3.selectAll('.symbol-list-group').remove();
      currentSymbolListNode = null;
    }
    
    function showSmellDetails(node) {
      if (node.type !== 'file') return;
      
      hideSmellDetails();
      
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      
      if (scale < 0.5) return;
      
      currentSmellDetailsNode = node;
      
      const score = node.smellScore || 0;
      const details = node.smellDetails;
      
      const panelGroup = g.append('g')
        .attr('class', 'smell-details-group')
        .attr('transform', `translate(${node.x}, ${node.y + node.size / 4 + 20})`);
      
      let metricsHTML = '';
      if (details) {
        metricsHTML = `
          <div class="smell-metric">Functions: <span class="smell-metric-value">${details.functionCount}</span></div>
          <div class="smell-metric">Avg func len: <span class="smell-metric-value">${Math.round(details.avgFunctionLength)}</span></div>
          <div class="smell-metric">Max func len: <span class="smell-metric-value">${details.maxFunctionLength}</span></div>
          <div class="smell-metric">Max nesting: <span class="smell-metric-value">${details.maxNestingDepth}</span></div>
          <div class="smell-metric">Imports: <span class="smell-metric-value">${details.importCount}</span></div>
        `;
      } else {
        metricsHTML = `<div class="smell-metric">No data available</div>`;
      }
      
      let scoreClass = 'clean';
      if (score > 80) scoreClass = 'high';
      else if (score > 60) scoreClass = 'significant';
      else if (score > 40) scoreClass = 'moderate';
      else if (score > 20) scoreClass = 'minor';
      
      const panelHTML = `
        <div class="smell-details-panel visible">
          <div class="smell-header">Code smell score: <span class="smell-score ${scoreClass}">${score}</span></div>
          <div class="smell-metrics">
            ${metricsHTML}
          </div>
        </div>
      `;
      
      const lines = [
        `Code smell score: ${score}`,
        `Functions: ${details?.functionCount || 0}`,
        `Avg func len: ${details ? Math.round(details.avgFunctionLength) : 0}`,
        `Max func len: ${details?.maxFunctionLength || 0}`,
        `Max nesting: ${details?.maxNestingDepth || 0}`,
        `Imports: ${details?.importCount || 0}`
      ];
      const longestLine = lines.reduce((max, line) => line.length > max.length ? line : max, '');
      
      const estimatedWidth = Math.max(
        longestLine.length * 7 + 26,
        180
      );
      const panelWidth = Math.min(Math.ceil(estimatedWidth), 350);
      const panelHeight = 130;
      
      panelGroup.append('foreignObject')
        .attr('x', -panelWidth / 2)
        .attr('y', 0)
        .attr('width', panelWidth)
        .attr('height', panelHeight)
        .style('overflow', 'visible')
        .html(panelHTML);
    }
    
    function hideSmellDetails() {
      d3.selectAll('.smell-details-group').remove();
      currentSmellDetailsNode = null;
    }
    
    function updateSmellDetailsPosition() {
      checkAndShowCenteredFile();
      
      if (currentSmellDetailsNode) {
        const node = currentSmellDetailsNode;
        d3.selectAll('.smell-details-group')
          .attr('transform', `translate(${node.x}, ${node.y + node.size / 4 + 20})`);
      }
    }
    
    function updateSymbolTrianglesVisibility() {
      if (!graphData) return;
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      
      d3.selectAll('.symbol-triangle').classed('visible', false);
      
      if (scale < 1.0) return;
      
      const centerX = (width / 2 - currentTransform.x) / scale;
      const centerY = ((height + 70) / 2 - currentTransform.y) / scale;
      
      let closestNode = null;
      let minDistance = Infinity;
      
      graphData.nodes.forEach(node => {
        if (node.type !== 'file') return;
        
        const dx = node.x - centerX;
        const dy = node.y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < node.size && distance < minDistance) {
          minDistance = distance;
          closestNode = node;
        }
      });
      
      if (closestNode) {
        d3.selectAll('.symbol-triangle')
          .filter(function() {
            const node = d3.select(this.parentNode).datum();
            return node === closestNode;
          })
          .classed('visible', true);
      }
    }
    
    function updateCenteredElements() {
      updateCopyButtonVisibility();
      updatePinIndicatorVisibility();
      updateSmellDetailsPosition();
      updateSymbolTrianglesVisibility();
      
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      if (scale < 1.0) {
        hideSymbolListImmediately();
      }
    }
    
    function checkAndShowCenteredFile() {
      if (!graphData) return;
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      
      if (scale < 1.0) {
        hideSmellDetails();
        return;
      }
      
      const centerX = (width / 2 - currentTransform.x) / scale;
      const centerY = ((height + 70) / 2 - currentTransform.y) / scale;
      
      let closestNode = null;
      let minDistance = Infinity;
      
      graphData.nodes.forEach(node => {
        if (node.type !== 'file') return;
        
        const dx = node.x - centerX;
        const dy = node.y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < node.size && distance < minDistance) {
          minDistance = distance;
          closestNode = node;
        }
      });
      
      if (!closestNode) {
        hideSmellDetails();
        return;
      }
      
      if (closestNode !== currentSmellDetailsNode) {
        hideSmellDetails();
        showSmellDetails(closestNode);
      }
    }
    
    function updateCopyButtonVisibility() {
      if (!graphData) return;
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      
      if (scale < 1.0) {
        d3.selectAll('.copy-button').classed('visible', false);
        currentCenteredNode = null;
        return;
      }
      
      const centerX = (width / 2 - currentTransform.x) / scale;
      const centerY = ((height + 70) / 2 - currentTransform.y) / scale;
      
      let closestNode = null;
      let minDistance = Infinity;
      
      graphData.nodes.forEach(node => {
        if (node.type !== 'file') return;
        
        const dx = node.x - centerX;
        const dy = node.y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < node.size && distance < minDistance) {
          minDistance = distance;
          closestNode = node;
        }
      });
      
      if (closestNode !== currentCenteredNode) {
        d3.selectAll('.copy-button').classed('visible', false);
        
        if (closestNode) {
          d3.selectAll('.copy-button')
            .filter(function() {
              const node = d3.select(this.parentNode).datum();
              return node === closestNode;
            })
            .classed('visible', true);
        }
        
        currentCenteredNode = closestNode;
      }
    }
    
    function updatePinIndicatorVisibility() {
      if (!graphData) return;
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      const currentTransform = d3.zoomTransform(svg.node());
      const scale = currentTransform.k;
      
      const centerX = (width / 2 - currentTransform.x) / scale;
      const centerY = ((height + 70) / 2 - currentTransform.y) / scale;
      
      let closestDir = null;
      let minDistance = Infinity;
      
      graphData.nodes.forEach(node => {
        if (node.type !== 'directory') return;
        if (node.fx == null || node.fy == null) return;
        
        const dx = node.x - centerX;
        const dy = node.y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        const MAX_DIR_SCALE = 8.0;
        let dirSizeMultiplier = 1;
        if (scale >= 1) {
          dirSizeMultiplier = 1;
        } else {
          dirSizeMultiplier = Math.min(MAX_DIR_SCALE, 1 / scale);
        }
        
        const fontSizes = [56, 40, 26, 16];
        const fontSize = fontSizes[Math.min(node.depth || 0, fontSizes.length - 1)] * dirSizeMultiplier;
        const parts = node.label.split('/');
        const dirName = parts[parts.length - 1];
        const dirNameWidth = dirName.length * fontSize * 0.7;
        const calculatedWidth = dirNameWidth + 60;
        const minWidths = [280, 180, 130, 100];
        const minWidth = minWidths[Math.min(node.depth || 0, minWidths.length - 1)] * dirSizeMultiplier;
        const dirWidth = Math.max(calculatedWidth, minWidth);
        const dirHeight = fontSize * 1.8;
        const dirSize = Math.max(dirWidth, dirHeight);
        
        if (distance < dirSize && distance < minDistance) {
          minDistance = distance;
          closestDir = node;
        }
      });
      
      d3.selectAll('.pin-indicator').classed('visible', false);
      
      if (closestDir) {
        d3.selectAll('.pin-indicator')
          .filter(function() {
            const node = d3.select(this.parentNode).datum();
            return node === closestDir;
          })
          .classed('visible', true);
      }
    }
    
    function zoomToNode(node) {
      if (!svg || !zoom) return;
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      
      const scale = 1.2;
      const x = width / 2 - node.x * scale;
      const y = (height + 70) / 2 - node.y * scale;
      
      if (simulation) {
        simulation.stop();
      }
      
      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
    }
    
    function nodeMatchesSearch(node) {
      if (!searchQuery) return true;
      const label = node.label.toLowerCase();
      return label.includes(searchQuery);
    }
    
    function applySearchFilter() {
      if (!graphData) return;
      
      // Collect filtered nodes for navigation
      filteredNodes = [];
      currentFilteredIndex = -1;
      
      if (searchQuery) {
        graphData.nodes.forEach(node => {
          if (nodeMatchesSearch(node)) {
            filteredNodes.push(node);
          }
        });
      }
      
      d3.selectAll('.file-rect')
        .transition()
        .duration(200)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (nodeMatchesSearch(node)) {
            return getFileColor(node);
          }
          return '#444';
        });
      
      d3.selectAll('.file-label')
        .transition()
        .duration(200)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (nodeMatchesSearch(node)) {
            return getTextColor(node);
          }
          return '#888';
        });
      
      d3.selectAll('.dir-rect')
        .transition()
        .duration(200)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (nodeMatchesSearch(node)) {
            return getDirBoxColor(node.path);
          }
          return '#444';
        });
      
      d3.selectAll('.directory-name')
        .transition()
        .duration(200)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (nodeMatchesSearch(node)) {
            return '#000';
          }
          return '#888';
        });
      
      d3.selectAll('.node-sublabel')
        .transition()
        .duration(200)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (nodeMatchesSearch(node)) {
            return '#999';
          }
          return '#666';
        });
    }
    
    // Navigate to next filtered node
    function navigateToNextFilteredNode() {
      if (filteredNodes.length === 0) {
        console.log('[Files Map] No filtered nodes to navigate');
        return;
      }
      
      // Move to next index, wrapping around to 0 after the last item
      currentFilteredIndex = (currentFilteredIndex + 1) % filteredNodes.length;
      
      const node = filteredNodes[currentFilteredIndex];
      console.log('[Files Map] Navigating to filtered node ' + (currentFilteredIndex + 1) + '/' + filteredNodes.length + ': ' + node.label);
      
      // Zoom to the node
      zoomToNode(node);
    }
    
    function updateColors() {
      if (!graphData) return;
      
      d3.selectAll('.file-rect')
        .transition()
        .duration(300)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (!nodeMatchesSearch(node)) return '#444';
          return getFileColor(node);
        });
      
      d3.selectAll('.file-label')
        .transition()
        .duration(300)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (!nodeMatchesSearch(node)) return '#888';
          return getTextColor(node);
        });
      
      d3.selectAll('.dir-rect')
        .transition()
        .duration(300)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (!nodeMatchesSearch(node)) return '#444';
          return getDirBoxColor(node.path);
        });
      
      d3.selectAll('.directory-name')
        .transition()
        .duration(300)
        .style('fill', function() {
          const node = d3.select(this.parentNode).datum();
          if (!nodeMatchesSearch(node)) return '#888';
          return '#000';
        });
    }
    
    function renderGraph(data) {
      graphData = data;
      
      const nodes = data.nodes;
      const edges = data.edges;
      
      nodes.forEach(node => {
        if (node.type === 'directory' && savedLayout[node.path]) {
          node.fx = savedLayout[node.path].x;
          node.fy = savedLayout[node.path].y;
        }
      });
      
      console.log('[Files Map Demo] Total nodes:', nodes.length);
      console.log('[Files Map Demo] File nodes:', nodes.filter(n => n.type === 'file').length);
      console.log('[Files Map Demo] Directory nodes:', nodes.filter(n => n.type === 'directory').length);
      
      g.selectAll('*').remove();
      
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      
      const containmentEdges = edges.filter(e => e.type === 'contains');
      
      function getDirSize(depth) {
        const baseSizes = [400, 300, 220, 160];
        return baseSizes[Math.min(depth, baseSizes.length - 1)];
      }
      
      function getDirFontSize(depth) {
        const fontSizes = [64, 44, 28, 18];
        return fontSizes[Math.min(depth, fontSizes.length - 1)];
      }
      
      function getTextWidth(text, fontSize) {
        const parts = text.split('/');
        const dirName = parts[parts.length - 1];
        const dirNameWidth = dirName.length * fontSize * 0.6;
        const calculatedWidth = dirNameWidth + 40;
        const minWidths = [200, 130, 90, 70];
        const minWidth = minWidths[Math.min(parts.length - 1, minWidths.length - 1)];
        return Math.max(calculatedWidth, minWidth);
      }
      
      updateDirectorySizes = function(zoomScale) {
        if (zoomScale === undefined) return;
        
        const MAX_DIR_SCALE = 8.0;
        
        let dirSizeMultiplier = 1;
        
        if (zoomScale >= 1) {
          dirSizeMultiplier = 1;
        } else {
          dirSizeMultiplier = Math.min(MAX_DIR_SCALE, 1 / zoomScale);
        }
        
        d3.selectAll('.dir-rect')
          .attr('d', function() {
            const node = d3.select(this.parentNode).datum();
            if (!node || node.type !== 'directory') return null;
            
            const fontSizes = [56, 40, 26, 16];
            const fontSize = fontSizes[Math.min(node.depth || 0, fontSizes.length - 1)] * dirSizeMultiplier;
            
            const parts = node.label.split('/');
            const dirName = parts[parts.length - 1];
            const dirNameWidth = dirName.length * fontSize * 0.7;
            const calculatedWidth = dirNameWidth + 60;
            
            const minWidths = [280, 180, 130, 100];
            const minWidth = minWidths[Math.min(node.depth || 0, minWidths.length - 1)] * dirSizeMultiplier;
            
            const width = Math.max(calculatedWidth, minWidth);
            const height = fontSize * 1.8;
            
            const indent = height * 0.4;
            const halfWidth = width / 2;
            const halfHeight = height / 2;
            
            return `
              M ${-halfWidth + indent},${-halfHeight}
              L ${halfWidth - indent},${-halfHeight}
              L ${halfWidth},0
              L ${halfWidth - indent},${halfHeight}
              L ${-halfWidth + indent},${halfHeight}
              L ${-halfWidth},0
              Z
            `;
          });
        
        d3.selectAll('.directory-name')
          .style('font-size', function() {
            const node = d3.select(this.parentNode).datum();
            if (!node || node.type !== 'directory') return null;
            const fontSizes = [56, 40, 26, 16];
            const fontSize = fontSizes[Math.min(node.depth || 0, fontSizes.length - 1)] * dirSizeMultiplier;
            return fontSize + 'px';
          })
          .each(function() {
            const node = d3.select(this.parentNode).datum();
            if (!node || node.type !== 'directory') return;
            
            const parts = node.label.split('/');
            d3.select(this).text(parts[parts.length - 1]);
          });
      }
      
      
      const dirToFiles = new Map();
      const dirNodeMap = new Map();
      
      nodes.forEach(node => {
        if (node.type === 'directory') {
          dirNodeMap.set(node.path, node);
        }
      });
      
      nodes.forEach(node => {
        if (node.type === 'file') {
          const fileDir = node.path.substring(0, node.path.lastIndexOf('/'));
          if (!dirToFiles.has(fileDir)) {
            dirToFiles.set(fileDir, []);
          }
          dirToFiles.get(fileDir).push(node);
        }
      });
      
      // Build directory hierarchy
      const dirHierarchy = new Map(); // parentPath -> [childDirs]
      const rootDirs = [];
      const dirToParentEdges = []; // Store directory-to-parent edges
      
      nodes.forEach(node => {
        if (node.type === 'directory') {
          const parentPath = node.path.substring(0, node.path.lastIndexOf('/'));
          if (parentPath && dirNodeMap.has(parentPath)) {
            if (!dirHierarchy.has(parentPath)) {
              dirHierarchy.set(parentPath, []);
            }
            dirHierarchy.get(parentPath).push(node);
            
            // Create edge from parent to child directory
            const parentNode = dirNodeMap.get(parentPath);
            dirToParentEdges.push({
              source: parentNode,
              target: node,
              type: 'contains'
            });
          } else {
            rootDirs.push(node);
          }
        }
      });
      
      // Position directories in circles around their parents with depth-based spacing
      const BASE_DIR_RADIUS = 1300; // Base radius between directories
      const DIRS_PER_LAYER = 8;
      
      // Calculate required file space for a directory based on its file count and sizes
      function calculateFileSpace(dirPath) {
        const files = dirToFiles.get(dirPath) || [];
        if (files.length === 0) return 0;
        
        // Use the same layer config as file positioning
        const LAYER_CONFIG = [
          { maxFiles: 8, radius: 392 },
          { maxFiles: 12, radius: 672 },
          { maxFiles: 18, radius: 1008 }
        ];
        
        // Determine which layer the last file will be in
        let maxRadius = LAYER_CONFIG[0].radius;
        let cumulativeFiles = 0;
        
        for (let i = 0; i < LAYER_CONFIG.length; i++) {
          cumulativeFiles += LAYER_CONFIG[i].maxFiles;
          if (files.length <= cumulativeFiles) {
            maxRadius = LAYER_CONFIG[i].radius;
            break;
          }
        }
        
        // If more files than configured layers, use last layer radius
        if (files.length > cumulativeFiles) {
          maxRadius = LAYER_CONFIG[LAYER_CONFIG.length - 1].radius;
        }
        
        // Calculate average file size in this directory
        // Files range from 160px to 360px width (80px to 180px height)
        const avgFileWidth = files.reduce((sum, f) => sum + f.size, 0) / files.length;
        const avgFileHeight = avgFileWidth / 2;
        
        // Estimate the actual area occupied by files at the outermost radius
        // Account for: radius + half file height + spacing
        const fileAreaBuffer = avgFileHeight / 2 + 40; // Half height + 40px spacing
        
        return maxRadius + fileAreaBuffer;
      }
      
      // Position root directories with significant separation for distinct graphs
      if (rootDirs.length === 1) {
        // Single root - center it
        const dirNode = rootDirs[0];
        if (dirNode.fx === undefined && dirNode.fy === undefined) {
          dirNode.x = width / 2;
          dirNode.y = height / 2;
          dirNode.fx = dirNode.x;
          dirNode.fy = dirNode.y;
        } else {
          // Has saved position - use it
          dirNode.x = dirNode.fx;
          dirNode.y = dirNode.fy;
        }
      } else {
        // Multiple roots - position them far apart horizontally
        // Separate roots with saved positions from those without
        const rootsWithoutSavedPos = rootDirs.filter(r => r.fx === undefined && r.fy === undefined);
        const rootsWithSavedPos = rootDirs.filter(r => r.fx !== undefined && r.fy !== undefined);
        
        // Position roots that don't have saved positions
        if (rootsWithoutSavedPos.length > 0) {
          // Calculate spacing based on each root's file count
          const rootSpacing = [];
          rootsWithoutSavedPos.forEach(root => {
            const fileSpace = calculateFileSpace(root.path);
            const totalRadius = fileSpace + BASE_DIR_RADIUS;
            rootSpacing.push(totalRadius * 2); // Double for full diameter
          });
          
          // Calculate total width needed
          const totalWidth = rootSpacing.reduce((sum, space) => sum + space, 0);
          const padding = 2000; // Extra padding between graphs
          const totalWithPadding = totalWidth + (padding * (rootsWithoutSavedPos.length - 1));
          
          // Position roots horizontally with appropriate spacing
          let currentX = width / 2 - totalWithPadding / 2;
          
          rootsWithoutSavedPos.forEach((dirNode, index) => {
            // Move to center of this root's allocated space
            currentX += rootSpacing[index] / 2;
            dirNode.x = currentX;
            dirNode.y = height / 2;
            dirNode.fx = dirNode.x;
            dirNode.fy = dirNode.y;
            // Move to start of next root's space
            currentX += rootSpacing[index] / 2 + padding;
          });
        }
        
        // For roots with saved positions, just use their saved positions
        rootsWithSavedPos.forEach(dirNode => {
          dirNode.x = dirNode.fx;
          dirNode.y = dirNode.fy;
        });
      }
      
      // Position child directories around their parents
      // Process directories level by level to ensure parents are positioned before children
      function positionChildrenRecursively(parentDir, grandparentDir = null) {
        const childDirs = dirHierarchy.get(parentDir.path);
        if (!childDirs || childDirs.length === 0) return;
        
        // Determine if parent is a root directory
        const isParentRoot = rootDirs.includes(parentDir);
        
        childDirs.forEach((childDir, index) => {
          // Skip positioning if this child already has a saved position
          if (childDir.fx !== undefined && childDir.fy !== undefined) {
            // Use the saved position
            childDir.x = childDir.fx;
            childDir.y = childDir.fy;
            
            // Still recursively position this directory's children
            positionChildrenRecursively(childDir, parentDir);
            return;
          }
          
          // Calculate file space needed for parent directory's files
          const parentFileSpace = calculateFileSpace(parentDir.path);
          
          // Calculate radius: parent's file space + base directory spacing
          // The child's depth does NOT affect its distance from parent
          const baseRadius = parentFileSpace + BASE_DIR_RADIUS;
          
          // Calculate which layer this directory belongs to
          const layer = Math.floor(index / DIRS_PER_LAYER);
          const indexInLayer = index % DIRS_PER_LAYER;
          const dirsInThisLayer = Math.min(DIRS_PER_LAYER, childDirs.length - layer * DIRS_PER_LAYER);
          
          // Add layer spacing if multiple layers
          const layerSpacing = layer * 500;
          const radius = baseRadius + layerSpacing;
          
          let angle;
          
          if (isParentRoot) {
            // Root directory children: place in full circle around parent
            const angleStep = (2 * Math.PI) / dirsInThisLayer;
            angle = indexInLayer * angleStep;
          } else {
            // Non-root directory children: place in a fan/arc away from grandparent
            
            // Calculate the angle from grandparent to parent (the "away" direction)
            let awayAngle;
            if (grandparentDir) {
              const dx = parentDir.x - grandparentDir.x;
              const dy = parentDir.y - grandparentDir.y;
              awayAngle = Math.atan2(dy, dx);
            } else {
              // If no grandparent (shouldn't happen for non-root), default to right
              awayAngle = 0;
            }
            
            // Create a fan of children around the "away" direction
            // Fan spread: 120 degrees (2/3 of PI radians)
            const fanSpread = (2 * Math.PI) / 3;
            const fanStart = awayAngle - fanSpread / 2;
            
            if (dirsInThisLayer === 1) {
              // Single child: place directly away from grandparent
              angle = awayAngle;
            } else {
              // Multiple children: spread in a fan
              const angleStep = fanSpread / (dirsInThisLayer - 1);
              angle = fanStart + (indexInLayer * angleStep);
            }
          }
          
          // Set position around parent's CURRENT position
          // This ensures children follow their parent even if parent has a saved position
          childDir.x = parentDir.x + Math.cos(angle) * radius;
          childDir.y = parentDir.y + Math.sin(angle) * radius;
          childDir.fx = childDir.x;
          childDir.fy = childDir.y;
          
          // Store the calculated values for debugging
          childDir.calculatedRadius = radius;
          
          // Recursively position this directory's children
          positionChildrenRecursively(childDir, parentDir);
        });
      }
      
      // Start positioning from root directories
      rootDirs.forEach(rootDir => {
        positionChildrenRecursively(rootDir);
      });
      
      // Layer configuration: [maxFiles, radius] - increased by 40%
      const LAYER_CONFIG = [
        { maxFiles: 8, radius: 392 },    // Layer 1: max 8 files (280 * 1.4)
        { maxFiles: 12, radius: 672 },   // Layer 2: max 12 files (480 * 1.4)
        { maxFiles: 18, radius: 1008 }   // Layer 3: max 18 files (720 * 1.4)
      ];
      
      dirToFiles.forEach((files, dirPath) => {
        const parentDir = dirNodeMap.get(dirPath);
        
        files.forEach((file, index) => {
          file.parentDir = parentDir; // Store direct reference to parent
          
          if (parentDir) {
            // Determine which layer this file belongs to
            let layer = 0;
            let filesBeforeThisLayer = 0;
            let cumulativeFiles = 0;
            
            for (let i = 0; i < LAYER_CONFIG.length; i++) {
              cumulativeFiles += LAYER_CONFIG[i].maxFiles;
              if (index < cumulativeFiles) {
                layer = i;
                filesBeforeThisLayer = cumulativeFiles - LAYER_CONFIG[i].maxFiles;
                break;
              }
            }
            
            // If we exceed all configured layers, use the last layer config
            if (index >= cumulativeFiles) {
              layer = LAYER_CONFIG.length - 1;
              filesBeforeThisLayer = cumulativeFiles - LAYER_CONFIG[layer].maxFiles;
            }
            
            // Calculate position within the layer
            const indexInLayer = index - filesBeforeThisLayer;
            const filesInThisLayer = Math.min(
              LAYER_CONFIG[layer].maxFiles,
              files.length - filesBeforeThisLayer
            );
            
            // Get radius for this layer
            const radius = LAYER_CONFIG[layer].radius;
            
            // Calculate angle for this file in its layer
            const angleStep = (2 * Math.PI) / filesInThisLayer;
            const angle = indexInLayer * angleStep;
            
            // Store layer and angle info
            file.targetAngle = angle;
            file.targetRadius = radius;
            file.layer = layer;
            
            // Set initial position
            file.x = parentDir.x + Math.cos(angle) * radius;
            file.y = parentDir.y + Math.sin(angle) * radius;
          } else {
            file.x = width / 2 + (Math.random() - 0.5) * 200;
            file.y = height / 2 + (Math.random() - 0.5) * 200;
          }
        });
      });
      
      // Collect all descendants for each directory (for group dragging)
      function collectDescendants(dirNode) {
        const descendants = [];
        
        // Get child directories
        const childDirs = dirHierarchy.get(dirNode.path) || [];
        childDirs.forEach(childDir => {
          descendants.push(childDir);
          // Recursively collect descendants of child directories
          const childDescendants = collectDescendants(childDir);
          descendants.push(...childDescendants);
        });
        
        // Get files in this directory
        const files = dirToFiles.get(dirNode.path) || [];
        descendants.push(...files);
        
        return descendants;
      }
      
      // Attach descendants to each directory node
      nodes.forEach(node => {
        if (node.type === 'directory') {
          node.descendants = collectDescendants(node);
        }
      });
      
      simulation = d3.forceSimulation(nodes)
        .velocityDecay(0.8)
        .force('orbit', alpha => {
          // Skip orbit force during resize to prevent files from flying away
          if (isResizing) return;
          
          nodes.forEach(node => {
            if (node.type !== 'file' || node.targetAngle === undefined || !node.parentDir || node.targetRadius === undefined) return;
            
            // Use stored parent reference and radius for this file's layer
            const parentDir = node.parentDir;
            const radius = node.targetRadius;
            
            // Calculate target position using the current parent position and layer radius
            const targetX = parentDir.x + Math.cos(node.targetAngle) * radius;
            const targetY = parentDir.y + Math.sin(node.targetAngle) * radius;
            
            // Calculate distance from target
            const dx = targetX - node.x;
            const dy = targetY - node.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Apply very strong force to lock files in their circular positions
            if (distance > 0) {
              const baseStrength = 2.0;
              // Increase strength based on distance (spring gets stronger when stretched)
              const distanceFactor = Math.min(distance / 100, 3);
              const strength = baseStrength * (1 + distanceFactor);
              node.vx += dx * strength;
              node.vy += dy * strength;
            }
          });
        });
      
      const edgeGroup = g.append('g').attr('class', 'edges');
      
      // Combine directory hierarchy edges with file containment edges
      const allEdges = [...dirToParentEdges, ...containmentEdges.filter(e => {
        const source = typeof e.source === 'object' ? e.source : nodes.find(n => n.id === e.source);
        const target = typeof e.target === 'object' ? e.target : nodes.find(n => n.id === e.target);
        return source && target && source.type === 'directory' && target.type === 'file';
      })];
      
      const edgeElements = edgeGroup.selectAll('path')
        .data(allEdges)
        .enter()
        .append('path')
        .attr('class', 'edge-directory')
        .style('stroke', d => {
          const source = d.source;
          const target = d.target;
          if (source.type === 'directory' && target.type === 'directory') {
            return '#4a9eff'; // Bright blue for directory hierarchy
          }
          return '#888'; // Gray for directory-to-file
        })
        .style('stroke-width', d => {
          const source = d.source;
          const target = d.target;
          if (source.type === 'directory' && target.type === 'directory') {
            return 5; // Thicker for directory hierarchy
          }
          return 1.5;
        })
        .style('opacity', d => {
          const source = d.source;
          const target = d.target;
          if (source.type === 'directory' && target.type === 'directory') {
            return 0.9; // More visible for directory hierarchy
          }
          return 0.5;
        })
        .style('fill', 'none');
      
      const nodeGroup = g.append('g').attr('class', 'nodes');
      
      // Separate file and directory nodes for proper layering
      const fileNodes = nodes.filter(n => n.type === 'file');
      const dirNodes = nodes.filter(n => n.type === 'directory');
      
      // Create file nodes first (will be rendered behind)
      const fileElements = nodeGroup.selectAll('g.node-file')
        .data(fileNodes)
        .enter()
        .append('g')
        .attr('class', 'node-file')
        .on('click', function(event, d) {
          if (simulation) {
            simulation.stop();
          }
          zoomToNode(d);
        })
        .on('dblclick', (event, d) => {
          event.stopPropagation();
          vscode.postMessage({ type: 'file:open', filePath: d.path });
        })
        .on('mouseenter', function(event, d) {
          if (isDragging) return;
          if (currentSymbolListNode) return;
          
          if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
          }
          
          tooltipTimeout = setTimeout(() => {
            if (!isDragging && !currentSymbolListNode) {
              showTooltip(event, d);
            }
          }, 200);
        })
        .on('mousemove', function(event, d) {
          if (tooltip && tooltip.classList.contains('visible')) {
            updateTooltipPosition(event);
          }
        })
        .on('mouseleave', function(event, d) {
          if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = null;
          }
          hideTooltip();
        });
      
      // Create directory nodes second (will be rendered on top)
      const dirElements = nodeGroup.selectAll('g.node-directory')
        .data(dirNodes)
        .enter()
        .append('g')
        .attr('class', 'node-directory')
        .call(d3.drag()
          .on('start', dragStarted)
          .on('drag', dragged)
          .on('end', dragEnded)
        )
        .on('click', function(event, d) {
          if (simulation) {
            simulation.stop();
          }
          zoomToNode(d);
        })
        .on('mouseenter', function(event, d) {
          if (isDragging) return;
          if (currentSymbolListNode) return;
          
          if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
          }
          
          tooltipTimeout = setTimeout(() => {
            if (!isDragging && !currentSymbolListNode) {
              showTooltip(event, d);
            }
          }, 200);
        })
        .on('mousemove', function(event, d) {
          if (tooltip && tooltip.classList.contains('visible')) {
            updateTooltipPosition(event);
          }
        })
        .on('mouseleave', function(event, d) {
          if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = null;
          }
          hideTooltip();
        });
      
      // Combine both for unified access
      const nodeElements = nodeGroup.selectAll('g.node-file, g.node-directory')
      
      console.log('[Files Map Demo] Creating file rectangles for', fileElements.size(), 'files');
      
      const fileRects = fileElements
        .append('rect')
        .attr('width', d => d.size)
        .attr('height', d => d.size / 2)
        .attr('x', d => -d.size / 2)
        .attr('y', d => -d.size / 4)
        .attr('rx', 4)
        .attr('ry', 4)
        .attr('class', 'file-rect')
        .style('fill', d => getFileColor(d));
      
      console.log('[Files Map Demo] File rectangles created:', fileRects.size());

      const dirRects = dirElements
        .append('path')
        .attr('d', d => {
          const fontSize = getDirFontSize(d.depth || 0);
          const width = getTextWidth(d.label, fontSize);
          const height = fontSize * 1.8;
          
          const indent = height * 0.4;
          const halfWidth = width / 2;
          const halfHeight = height / 2;
          
          return `
            M ${-halfWidth + indent},${-halfHeight}
            L ${halfWidth - indent},${-halfHeight}
            L ${halfWidth},0
            L ${halfWidth - indent},${halfHeight}
            L ${-halfWidth + indent},${halfHeight}
            L ${-halfWidth},0
            Z
          `;
        })
        .attr('class', 'dir-rect')
        .style('fill', d => getDirBoxColor(d.path))
        .style('stroke', '#fff')
        .style('stroke-width', 3);
      
      // Add file badges and symbols
      fileElements.append('rect')
        .attr('class', 'line-count-badge')
        .attr('width', d => {
          const text = String(d.lines);
          return Math.max(30, text.length * 7 + 10);
        })
        .attr('height', 16)
        .attr('x', d => {
          const text = String(d.lines);
          const badgeWidth = Math.max(30, text.length * 7 + 10);
          return -badgeWidth / 2;
        })
        .attr('y', d => -d.size / 4 + 2)
        .attr('rx', 8)
        .attr('ry', 8)
        .style('fill', 'rgba(0, 0, 0, 0.6)')
        .style('stroke', 'rgba(255, 255, 255, 0.3)')
        .style('stroke-width', 1);
      
      fileElements.append('text')
        .attr('class', 'node-sublabel')
        .attr('x', 0)
        .attr('y', d => -d.size / 4 + 14)
        .text(d => `${d.lines}`);
      
      const functionsTriangle = fileElements.append('g')
        .attr('class', d => {
          const baseClass = 'symbol-triangle functions-triangle';
          return d.functions.length === 0 ? baseClass + ' empty' : baseClass;
        })
        .attr('transform', d => {
          const x = d.size / 2 + 15;
          const y = 0;
          return `translate(${x}, ${y})`;
        })
        .on('mouseenter', function(event, d) {
          if (d.functions.length > 0) {
            if (symbolListHideTimeout) {
              clearTimeout(symbolListHideTimeout);
              symbolListHideTimeout = null;
            }
            showSymbolList(d, 'functions');
          }
        })
        .on('mouseleave', function(event, d) {
          hideSymbolListWithDelay();
        });
      
      functionsTriangle.append('rect')
        .attr('x', -8)
        .attr('y', -8)
        .attr('width', 16)
        .attr('height', 16)
        .attr('rx', 3)
        .attr('ry', 3);
      
      functionsTriangle.append('text')
        .attr('x', 0)
        .attr('y', 0)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', '10px')
        .style('font-weight', 'bold')
        .style('fill', '#000')
        .style('pointer-events', 'none')
        .text('f');
      
      const variablesTriangle = fileElements.append('g')
        .attr('class', d => {
          const baseClass = 'symbol-triangle variables-triangle';
          return d.variables.length === 0 ? baseClass + ' empty' : baseClass;
        })
        .attr('transform', d => {
          const x = -d.size / 2 - 15;
          const y = 0;
          return `translate(${x}, ${y})`;
        })
        .on('mouseenter', function(event, d) {
          if (d.variables.length > 0) {
            if (symbolListHideTimeout) {
              clearTimeout(symbolListHideTimeout);
              symbolListHideTimeout = null;
            }
            showSymbolList(d, 'variables');
          }
        })
        .on('mouseleave', function(event, d) {
          hideSymbolListWithDelay();
        });
      
      variablesTriangle.append('rect')
        .attr('x', -8)
        .attr('y', -8)
        .attr('width', 16)
        .attr('height', 16)
        .attr('rx', 3)
        .attr('ry', 3);
      
      variablesTriangle.append('text')
        .attr('x', 0)
        .attr('y', 0)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', '10px')
        .style('font-weight', 'bold')
        .style('fill', '#000')
        .style('pointer-events', 'none')
        .text('v');
      
      const typesTriangle = fileElements.append('g')
        .attr('class', d => {
          const baseClass = 'symbol-triangle types-triangle';
          return d.types.length === 0 ? baseClass + ' empty' : baseClass;
        })
        .attr('transform', d => {
          const x = 0;
          const y = -d.size / 4 - 15;
          return `translate(${x}, ${y})`;
        })
        .on('mouseenter', function(event, d) {
          if (d.types.length > 0) {
            if (symbolListHideTimeout) {
              clearTimeout(symbolListHideTimeout);
              symbolListHideTimeout = null;
            }
            showSymbolList(d, 'types');
          }
        })
        .on('mouseleave', function(event, d) {
          hideSymbolListWithDelay();
        });
      
      typesTriangle.append('rect')
        .attr('x', -8)
        .attr('y', -8)
        .attr('width', 16)
        .attr('height', 16)
        .attr('rx', 3)
        .attr('ry', 3);
      
      typesTriangle.append('text')
        .attr('x', 0)
        .attr('y', 0)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', '10px')
        .style('font-weight', 'bold')
        .style('fill', '#000')
        .style('pointer-events', 'none')
        .text('t');
      
      const copyButtonGroup = fileElements.append('g')
        .attr('class', 'copy-button')
        .attr('transform', d => {
          const margin = 12;
          const x = d.size / 2 - margin;
          const y = d.size / 4 - margin;
          return `translate(${x}, ${y})`;
        })
        .on('click', function(event, d) {
          event.stopPropagation();
          vscode.postMessage({ type: 'file:copy', filePath: d.path });
        })
        .on('mouseenter', function(event, d) {
          showTooltip(event, { type: 'copy-button', label: 'Copy file path' });
        })
        .on('mousemove', function(event, d) {
          updateTooltipPosition(event);
        })
        .on('mouseleave', function(event, d) {
          hideTooltip();
        });
      
      copyButtonGroup.append('rect')
        .attr('class', 'copy-button-icon')
        .attr('x', -4)
        .attr('y', -3)
        .attr('width', 7)
        .attr('height', 8)
        .attr('rx', 1)
        .attr('ry', 1)
        .style('fill', 'none')
        .style('stroke', '#fff')
        .style('stroke-width', 1.2);
      
      copyButtonGroup.append('rect')
        .attr('class', 'copy-button-icon')
        .attr('x', -1)
        .attr('y', -6)
        .attr('width', 7)
        .attr('height', 8)
        .attr('rx', 1)
        .attr('ry', 1)
        .style('fill', 'none')
        .style('stroke', '#fff')
        .style('stroke-width', 1.2);
      
      dirElements
        .append('text')
        .attr('class', 'node-label directory-name')
        .attr('x', 0)
        .attr('y', 0)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', d => {
          const fontSizes = [56, 40, 26, 16];
          const fontSize = fontSizes[Math.min(d.depth || 0, fontSizes.length - 1)];
          return `${fontSize}px`;
        })
        .style('fill', '#000')
        .style('font-weight', 'bold')
        .style('overflow', 'hidden')
        .style('text-overflow', 'ellipsis')
        .style('white-space', 'nowrap')
        .each(function(d) {
          const parts = d.label.split('/');
          d3.select(this).text(parts[parts.length - 1]);
        });
      
      
      fileElements
        .append('text')
        .attr('class', 'node-label')
        .attr('x', 0)
        .attr('y', 0)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('class', 'file-label')
        .style('fill', d => getTextColor(d))
        .style('font-weight', 'normal')
        .style('pointer-events', 'none')
        .text(d => d.label)
        .each(function(d) {
          const textElement = this;
          const margin = 6;
          const availableWidth = d.size - (margin * 2);
          
          let fontSize = 28;
          const minFontSize = 8;
          
          let low = minFontSize;
          let high = fontSize;
          
          while (high - low > 0.5) {
            fontSize = (low + high) / 2;
            textElement.style.fontSize = fontSize + 'px';
            const textWidth = textElement.getComputedTextLength();
            
            if (textWidth > availableWidth) {
              high = fontSize;
            } else {
              low = fontSize;
            }
          }
          
          fontSize = low;
          textElement.style.fontSize = fontSize + 'px';
          
          const finalWidth = textElement.getComputedTextLength();
          if (finalWidth > availableWidth) {
            textElement.style.clipPath = 'inset(0 ' + margin + 'px 0 ' + margin + 'px)';
          }
        });
      
      simulation.on('tick', () => {
        // When resizing, directly lock files to their orbit positions
        // This prevents files from flying away during resize
        if (isResizing) {
          nodes.forEach(node => {
            if (node.type === 'file' && node.parentDir && node.targetAngle !== undefined && node.targetRadius !== undefined) {
              node.x = node.parentDir.x + Math.cos(node.targetAngle) * node.targetRadius;
              node.y = node.parentDir.y + Math.sin(node.targetAngle) * node.targetRadius;
              node.vx = 0;
              node.vy = 0;
            }
          });
        }
        
        edgeElements.attr('d', d => {
          // Guard against undefined coordinates
          if (d.source.x === undefined || d.source.y === undefined || 
              d.target.x === undefined || d.target.y === undefined) {
            return null;
          }
          const dx = d.target.x - d.source.x;
          const dy = d.target.y - d.source.y;
          const dr = Math.sqrt(dx * dx + dy * dy) * 2;
          return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
        });
        
        nodeElements.attr('transform', d => {
          if (d.x === undefined || d.y === undefined) return null;
          return `translate(${d.x},${d.y})`;
        });
        
        updateCenteredElements();
      });
    }
    
    function saveLayout() {
      if (!graphData) return;
      
      const layout = {};
      
      graphData.nodes.forEach(node => {
        if (node.type === 'directory' && node.fx !== undefined && node.fy !== undefined) {
          layout[node.path] = { x: node.fx, y: node.fy };
        }
      });
      
      vscode.postMessage({
        type: 'layout:save',
        layout
      });
    }
    
    function dragStarted(event, d) {
      d.dragStartX = event.x;
      d.dragStartY = event.y;
      d.wasDragged = false;
      
      isDragging = true;
      hideTooltip();
      
      if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
      }
      
      d.fx = d.x;
      d.fy = d.y;
      
      // If dragging a directory, collect all descendants for group movement
      if (d.type === 'directory' && d.descendants) {
        d.descendants.forEach(descendant => {
          descendant.dragOffsetX = descendant.x - d.x;
          descendant.dragOffsetY = descendant.y - d.y;
        });
      }
      
      if (simulation) {
        simulation.alphaTarget(0.1).restart();
      }
    }
    
    function dragged(event, d) {
      const dx = event.x - d.dragStartX;
      const dy = event.y - d.dragStartY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      const DEADZONE = 10;
      
      if (distance > DEADZONE) {
        d.wasDragged = true;
        d.fx = event.x;
        d.fy = event.y;
        
        // If dragging a directory, move all descendants with it
        if (d.type === 'directory' && d.descendants) {
          d.descendants.forEach(descendant => {
            descendant.fx = event.x + descendant.dragOffsetX;
            descendant.fy = event.y + descendant.dragOffsetY;
            descendant.x = descendant.fx;
            descendant.y = descendant.fy;
          });
        }
      }
    }
    
    function dragEnded(event, d) {
      isDragging = false;
      
      if (simulation) {
        // Keep simulation running to allow files to reposition around moved directory
        simulation.alphaTarget(0.5).restart();
        
        // Then gradually stop
        setTimeout(() => {
          if (simulation) {
            simulation.alphaTarget(0);
          }
        }, 1000);
      }
      
      if (d.type === 'directory' && d.wasDragged) {
        saveLayout();
      }
      
      if (d.wasDragged) {
        event.sourceEvent.stopPropagation();
      }
    }
    
    window.addEventListener('message', event => {
      const message = event.data;
      
      switch (message.type) {
        case 'graph:update':
          renderGraph(message.data);
          break;
        case 'layout:loaded':
          savedLayout = message.layout || {};
          console.log('[Files Map Demo] Layout loaded with', Object.keys(savedLayout).length, 'directory positions');
          if (graphData) {
            graphData.nodes.forEach(node => {
              if (node.type === 'directory' && savedLayout[node.path]) {
                node.fx = savedLayout[node.path].x;
                node.fy = savedLayout[node.path].y;
                node.x = savedLayout[node.path].x;
                node.y = savedLayout[node.path].y;
              }
            });
            if (simulation) {
              simulation.alpha(0.3).restart();
            }
          }
          break;
        case 'dir:unpinned':
          if (savedLayout[message.dirPath]) {
            delete savedLayout[message.dirPath];
          }
          
          if (graphData) {
            const node = graphData.nodes.find(n => n.type === 'directory' && n.path === message.dirPath);
            if (node) {
              node.fx = null;
              node.fy = null;
              
              updatePinIndicatorVisibility();
              
              if (simulation) {
                simulation.alpha(0.5).restart();
              }
            }
          }
          break;
      }
    });
    
    // Handle visibility changes (when panel is moved or becomes visible)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && graphData) {
        console.log('[Files Map] Panel became visible, refreshing rendering');
        // Force a re-render of all elements
        d3.selectAll('.node-file, .node-directory')
          .attr('transform', d => `translate(${d.x},${d.y})`);
        
        // Restore directory sizes based on current zoom level
        if (updateDirectorySizes && svg) {
          const currentTransform = d3.zoomTransform(svg.node());
          updateDirectorySizes(currentTransform.k);
        }
        
        // Restart simulation briefly to ensure proper positioning
        if (simulation) {
          simulation.alpha(0.1).restart();
          setTimeout(() => {
            if (simulation) {
              simulation.alpha(0);
            }
          }, 100);
        }
      }
    });
    
    // Handle window resize - just update SVG dimensions, keep nodes in place
    window.addEventListener('resize', () => {
      const width = window.innerWidth;
      const height = window.innerHeight - 70;
      svg.attr('width', width).attr('height', height);
    });
    
    init();
  </script>
</body>
</html>

